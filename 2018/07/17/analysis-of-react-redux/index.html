<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="javascript,react,react-redux,redux," />





  <link rel="alternate" href="/atom.xml" title="Myths" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/logo.jpg?v=5.1.1" />






<meta name="description" content="简介redux 和 react-redux 是两个不同的库，redux 的出现是为了解决大型应用中组件状态管理混乱的问题，react-redux 则是便于 redux 结合 react.js 来使用。在阅读本文之前，您需要了解 redux 及 react 的基本用法。本文省略了源码中的一些对理解影响不大的代码，只对核心源码做分析。
reduxredux 是真正的状态管理者，其通过闭包使状态数据永久">
<meta property="og:type" content="article">
<meta property="og:title" content="redux和react-redux原理分析">
<meta property="og:url" content="http://myt0.com/2018/07/17/analysis-of-react-redux/index.html">
<meta property="og:site_name" content="Myths">
<meta property="og:description" content="简介redux 和 react-redux 是两个不同的库，redux 的出现是为了解决大型应用中组件状态管理混乱的问题，react-redux 则是便于 redux 结合 react.js 来使用。在阅读本文之前，您需要了解 redux 及 react 的基本用法。本文省略了源码中的一些对理解影响不大的代码，只对核心源码做分析。
reduxredux 是真正的状态管理者，其通过闭包使状态数据永久">
<meta property="og:updated_time" content="2018-07-17T15:04:27.341Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redux和react-redux原理分析">
<meta name="twitter:description" content="简介redux 和 react-redux 是两个不同的库，redux 的出现是为了解决大型应用中组件状态管理混乱的问题，react-redux 则是便于 redux 结合 react.js 来使用。在阅读本文之前，您需要了解 redux 及 react 的基本用法。本文省略了源码中的一些对理解影响不大的代码，只对核心源码做分析。
reduxredux 是真正的状态管理者，其通过闭包使状态数据永久">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://myt0.com/2018/07/17/analysis-of-react-redux/"/>





  <title>redux和react-redux原理分析 | Myths</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Myths</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Myt0's blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://myt0.com/2018/07/17/analysis-of-react-redux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Myths">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Myths">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">redux和react-redux原理分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-17T23:00:00+08:00">
                2018-07-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>redux 和 react-redux 是两个不同的库，redux 的出现是为了解决大型应用中组件状态管理混乱的问题，react-redux 则是便于 redux 结合 react.js 来使用。<br>在阅读本文之前，您需要了解 redux 及 react 的基本用法。<br>本文省略了源码中的一些对理解影响不大的代码，只对核心源码做分析。</p>
<h2 id="redux"><a href="#redux" class="headerlink" title="redux"></a>redux</h2><p>redux 是真正的状态管理者，其通过闭包使状态数据永久地保存在内存当中，通过闭包来改变和获取状态数据。<br>redux 一共导出了五个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    createStore,</span><br><span class="line">    combineReducers,</span><br><span class="line">    bindActionCreators,</span><br><span class="line">    applyMiddleware,</span><br><span class="line">    compose</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createStore"><a href="#createStore" class="headerlink" title="createStore"></a>createStore</h3><p>createStore 用来创建一个存储对象，其共有三个参数</p>
<ol>
<li><p>reducer 是 redux 的核心部分，reducer 的作用就是来改变数据的<br>createStore 返回一个我们称之为 store 的对象，调用其 store 的 dispatch 方法会自动调用我们传入的 reducer，用 reducer 的返回值改变 state</p>
</li>
<li><p>preloadedState 是初始化状态</p>
</li>
<li>enhancer 的中文意思是增强器，其实就是一个包装函数</li>
</ol>
<p>以下是其部分源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _ref2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        enhancer = preloadedState;</span><br><span class="line">        preloadedState = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将reducer, preloaderState存在局部变量里，同时初始化listeners为一个数组</span></span><br><span class="line">    <span class="keyword">var</span> currentReducer = reducer;</span><br><span class="line">    <span class="keyword">var</span> currentState = preloadedState;</span><br><span class="line">    <span class="keyword">var</span> currentListeners = [];</span><br><span class="line">    <span class="keyword">var</span> nextListeners = currentListeners;</span><br><span class="line">    <span class="comment">// 是否正在调用reducer</span></span><br><span class="line">    <span class="keyword">var</span> isDispatching = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回当前状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加监听函数，同时返回一个取消监听本次添加的函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> isSubscribed = <span class="literal">true</span>;</span><br><span class="line">        nextListeners.push(listener);</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            isSubscribed = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> index = nextListeners.indexOf(listener);</span><br><span class="line">            nextListeners.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在dispatch中调用reducer，由reducer判断action来改变当前状态</span></span><br><span class="line">    <span class="comment">// redux约定所有的状态改变都是通过dispatch调用reducer</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isDispatching = <span class="literal">true</span>;</span><br><span class="line">            currentState = currentReducer(currentState, action);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            isDispatching = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环调用listener</span></span><br><span class="line">        <span class="keyword">var</span> listeners = currentListeners = nextListeners;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> listener = listeners[i];</span><br><span class="line">            listener();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接使用传入的新reducer改变当前reducer，同时触发一个REPLACE action</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">        currentReducer = nextReducer;</span><br><span class="line">        dispatch(&#123; type: ActionTypes.REPLACE &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _ref;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> outerSubscribe = subscribe;</span><br><span class="line">        <span class="keyword">return</span> _ref = &#123;</span><br><span class="line">                <span class="comment">/**</span><br><span class="line">                 * observer : &#123; next: function(state)&#123;&#125; &#125;</span><br><span class="line">                 */</span></span><br><span class="line">                subscribe: <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">observer</span>) </span>&#123;</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="title">observeState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (observer.next) &#123;</span><br><span class="line">                            observer.next(getState());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    observeState();</span><br><span class="line">                    <span class="comment">// 相当于在listener中传入getState</span></span><br><span class="line">                    <span class="keyword">var</span> unsubscribe = outerSubscribe(observeState);</span><br><span class="line">                    <span class="keyword">return</span> &#123; unsubscribe: unsubscribe &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, _ref[result] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// result只是一个独立的key</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">            &#125;, _ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后返回</span></span><br><span class="line">    <span class="keyword">return</span> _ref2 = &#123;</span><br><span class="line">        dispatch: dispatch,</span><br><span class="line">        subscribe: subscribe,</span><br><span class="line">        getState: getState,</span><br><span class="line">        replaceReducer: replaceReducer</span><br><span class="line">    &#125;, _ref2[result] = observable, _ref2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a>combineReducers</h3><p>这个方法接收一个 reducer 对象（key - value），返回一个函数，调用这个函数去触发所有传入的 reducer，然后改变 state，返回新的 state 集合</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">    <span class="keyword">var</span> finalReducers = &#123;&#125;</span><br><span class="line">    <span class="comment">// 复制到finalReducers</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> key = reducerKeys[i]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">            finalReducers[key] = reducers[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回一个函数，通过传入state集合和action调用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> state =</span><br><span class="line">            <span class="built_in">arguments</span>.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">arguments</span>[<span class="number">0</span>] !== <span class="literal">undefined</span></span><br><span class="line">                ? <span class="built_in">arguments</span>[<span class="number">0</span>]</span><br><span class="line">                : &#123;&#125;</span><br><span class="line">        <span class="keyword">var</span> action = <span class="built_in">arguments</span>[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">var</span> hasChanged = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">var</span> nextState = &#123;&#125;</span><br><span class="line">        <span class="comment">// 循环触发所有的reducer</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; finalReducerKeys.length; _i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> _key = finalReducerKeys[_i]</span><br><span class="line">            <span class="keyword">var</span> reducer = finalReducers[_key]</span><br><span class="line">            <span class="keyword">var</span> previousStateForKey = state[_key]</span><br><span class="line">            <span class="keyword">var</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> errorMessage = getUndefinedStateErrorMessage(_key, action)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</span><br><span class="line">            &#125;</span><br><span class="line">            nextState[_key] = nextStateForKey</span><br><span class="line">            <span class="comment">// 状态是否改变</span></span><br><span class="line">            hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据是否改变了state选择返回新的state或者原来的</span></span><br><span class="line">        <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bindActionCreators"><a href="#bindActionCreators" class="headerlink" title="bindActionCreators"></a>bindActionCreators</h3><p>我们介绍过，dispatch 会接受一个 action,并将当前 state 和 action 传入 reducer 然后返回新的 state<br>bindActionCreator 接收两个参数 actionCreator，dispatch，这个方法会生成一个函数，内容就是调用 dispatch，<br>actionCreator 就和它名字的含义一样，就是一个专门用于生成 action 的函数，然后由 dispatch 将生成的 action 传给 reducer,再做状态的改变。<br>bindActionCreators 则是通过对一组 actionCreator 做这样的操作，并且将最后的函数也以 key - value 对象的形式返回，key 值就是传入 actionCreators 的 key 值一一对应。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// actionCreators是函数，那么相当于bindActionCreator</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当actionCreators是一个对象的时候</span></span><br><span class="line">    <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</span><br><span class="line">    <span class="keyword">var</span> boundActionCreators = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> key = keys[i]</span><br><span class="line">        <span class="keyword">var</span> actionCreator = actionCreators[key]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">            boundActionCreators[key] = bindActionCreator(</span><br><span class="line">                actionCreator,</span><br><span class="line">                dispatch</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="applyMiddleware"><a href="#applyMiddleware" class="headerlink" title="applyMiddleware"></a>applyMiddleware</h3><p>middleware 顾名思义就是中间件，目的是在 dispatch 前后做一些记录之类的操作，这有点像 Koa 中的洋葱模型。<br>applyMiddleware 可以根据具体的用法去理解:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">&#123; getState &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> next =&gt; action =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'will dispatch'</span>, action)</span><br><span class="line">        <span class="keyword">const</span> returnValue = next(action)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'state after dispatch'</span>, getState())</span><br><span class="line">        <span class="keyword">return</span> returnValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// todos是个reducer</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(todos, [<span class="string">'Use Redux'</span>], applyMiddleware(logger))</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="keyword">const</span> store = applyMiddleware(logger)(createStore)(reducer, preloadedState)</span><br><span class="line"><span class="comment">// 此时的dispatch是处理过后的dispatch</span></span><br><span class="line">store.dispatch(&#123; type: <span class="string">'ACTION1'</span> &#125;)</span><br><span class="line"><span class="comment">// 相当于原始dispatch</span></span><br><span class="line"><span class="keyword">const</span> middle = [logger(middlewareAPI)]</span><br><span class="line">_dispatch = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> logger(middlewareAPI)(store.dispatch)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 即</span></span><br><span class="line">(action =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'will dispatch'</span>, action)</span><br><span class="line">        <span class="comment">// 此时的next就是store.dispatch</span></span><br><span class="line">        <span class="comment">// 如果是多个中间件，那么最后一个中间件的next是store.dispatch</span></span><br><span class="line">        <span class="comment">// 前面的中间件中的next是后一中间件， 最终action还是会传给dispatch</span></span><br><span class="line">        <span class="keyword">const</span> returnValue = next(action)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'state after dispatch'</span>, getState())</span><br><span class="line">        <span class="keyword">return</span> returnValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)(&#123; type: <span class="string">'ACTION1'</span> &#125;)</span><br></pre></td></tr></table></figure>
<p>源码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    return <span class="function"><span class="keyword">function</span>(<span class="params">createStore</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (</span><br><span class="line">                <span class="keyword">var</span> _len2 = <span class="built_in">arguments</span>.length, args = <span class="built_in">Array</span>(_len2), _key2 = <span class="number">0</span>;</span><br><span class="line">                _key2 &lt; _len2;</span><br><span class="line">                _key2++</span><br><span class="line">            ) &#123;</span><br><span class="line">                args[_key2] = <span class="built_in">arguments</span>[_key2]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用createStore正常创建store，并将参数传入，即我们上面例子中的reducer, preloadedState</span></span><br><span class="line">            <span class="keyword">var</span> store = createStore.apply(<span class="literal">undefined</span>, args)</span><br><span class="line">            <span class="keyword">var</span> _dispatch = <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">                    <span class="string">'Dispatching while constructing your middleware is not allowed. '</span> +</span><br><span class="line">                        <span class="string">'Other middleware would not be applied to this dispatch.'</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">                getState: store.getState,</span><br><span class="line">                dispatch: <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> _dispatch.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// middlewares即我们传入的中间件组成的数组</span></span><br><span class="line">            <span class="comment">// 循环调用middleware并传入middlewareAPI，这样我们的中间件就能取到getState了</span></span><br><span class="line">            <span class="keyword">var</span> chain = middlewares.map(<span class="function"><span class="keyword">function</span>(<span class="params">middleware</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> middleware(middlewareAPI)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// chain是middlewares遍历执行过后的结果组成的数组</span></span><br><span class="line">            <span class="comment">// 所以每次dispatch的时候会循环调用所有的middlewares</span></span><br><span class="line">            <span class="comment">// 即 middleware1(middleware2(middleware3(store.dispatch)))</span></span><br><span class="line">            _dispatch = compose.apply(<span class="literal">undefined</span>, chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> _extends(&#123;&#125;, store, &#123;</span><br><span class="line">                dispatch: _dispatch</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><p>传入多个 function, compose 会对这些 function 做链式调用，将后一函数执行结果传入前一函数，例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> func1 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> func2 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> func3 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> com = compose(</span><br><span class="line">    func1,</span><br><span class="line">    func2,</span><br><span class="line">    func3</span><br><span class="line">)</span><br><span class="line">com(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> func1(func2(func3(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合以下源码来分析：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 所有函数放到一个数组</span></span><br><span class="line">    <span class="keyword">for</span> (</span><br><span class="line">        <span class="keyword">var</span> _len = <span class="built_in">arguments</span>.length, funcs = <span class="built_in">Array</span>(_len), _key = <span class="number">0</span>;</span><br><span class="line">        _key &lt; _len;</span><br><span class="line">        _key++</span><br><span class="line">    ) &#123;</span><br><span class="line">        funcs[_key] = <span class="built_in">arguments</span>[_key]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    return funcs.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> a(b.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么 com 相当于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> func1(func2.apply(<span class="literal">undefined</span>, func3.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>createStore 创建局部对象，将我们传入的用于改变状态的 reducer 存起来，返回闭包函数组成的对象 store，强制约定取 state 通过 store.getState，改变 state 则必须通过调用 dispatch 触发 reducer 根据具体的 action 改变，同时加入中间件功能，使我们能够统一监听到状态的改变，满足更多的需求。而 combineReducers 则满足了组件模块化的需求。<br>redux 是一个非常精炼的库，可以说用最少的代码实现了完整的状态管理。</p>
<h2 id="react-redux"><a href="#react-redux" class="headerlink" title="react-redux"></a>react-redux</h2><p>react-redux 一共导出了 4 个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    Provider, createProvider, connectAdvanced, connect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h3><p>Provider 是 createProvider 执行返回的实例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Provider = createProvider()</span><br></pre></td></tr></table></figure>
<h3 id="createProvider"><a href="#createProvider" class="headerlink" title="createProvider"></a>createProvider</h3><p>createProvider 返回一个 Provider，会将我们传入的 props 放到其 childContext 中。<br>这一功能利用的是 react 提供的<a href="https://reactjs.org/docs/legacy-context.html" target="_blank" rel="external">getChildContext</a>方法，getChildContext 方法返回的对象可以在子组件中通过 this.context 取到，此方法在最新的 react 中属于遗弃方法，react 提供了最新的 <a href="https://reactjs.org/docs/context.html" target="_blank" rel="external">Context</a> 实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createProvider</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// _Component是react.Component， 所以Provider继承自react.Component</span></span><br><span class="line">    <span class="keyword">var</span> Provider = (<span class="function"><span class="keyword">function</span>(<span class="params">_Component</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 继承prototype</span></span><br><span class="line">        inherits(Provider, _Component)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getChildContext 实现之后，所有子组件都可以通过context取到返回的对象，通常就是我们传入的store</span></span><br><span class="line">        Provider.prototype.getChildContext = <span class="function"><span class="keyword">function</span> <span class="title">getChildContext</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _ref</span><br><span class="line">            <span class="comment">// 返回包含store的对象</span></span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                (_ref = &#123;&#125;),</span><br><span class="line">                (_ref[storeKey] = <span class="keyword">this</span>[storeKey]),</span><br><span class="line">                (_ref[subscriptionKey] = <span class="literal">null</span>),</span><br><span class="line">                _ref</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">Provider</span>(<span class="params">props, context</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 判断Provider是否可调用</span></span><br><span class="line">            classCallCheck(<span class="keyword">this</span>, Provider)</span><br><span class="line">            <span class="comment">// 继承实例</span></span><br><span class="line">            <span class="keyword">var</span> _this = possibleConstructorReturn(</span><br><span class="line">                <span class="keyword">this</span>,</span><br><span class="line">                _Component.call(<span class="keyword">this</span>, props, context)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将store存到实例里</span></span><br><span class="line">            _this[storeKey] = props.store</span><br><span class="line">            <span class="keyword">return</span> _this</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// render子组件</span></span><br><span class="line">        Provider.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> react.Children.only(<span class="keyword">this</span>.props.children)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Provider</span><br><span class="line">    &#125;)(react.Component)</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    return Provider</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>connect 生成一个容器组件，将 state 或者具体的 dispatch 注入到被包裹的组件当中。<br>connect 基本用法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; todos: state.todos &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; actions: bindActionCreators(actionCreators, dispatch) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps</span><br><span class="line">)(TodoApp)</span><br></pre></td></tr></table></figure>
<p>connect 部分源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps, mergeProps</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// mapStateToPropsFactories默认是</span></span><br><span class="line">    <span class="comment">// var defaultMapDispatchToPropsFactories = [whenMapDispatchToPropsIsFunction, whenMapDispatchToPropsIsMissing, whenMapDispatchToPropsIsObject];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历执行mapStateToPropsFactories中的函数并传入mapStateToProps，返回第一个不为falsy的执行结果</span></span><br><span class="line">    <span class="keyword">var</span> initMapStateToProps = match(mapStateToProps, mapStateToPropsFactories, <span class="string">'mapStateToProps'</span>);</span><br><span class="line">    <span class="keyword">var</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">'mapDispatchToProps'</span>);</span><br><span class="line">    <span class="keyword">var</span> initMergeProps = match(mergeProps, mergePropsFactories, <span class="string">'mergeProps'</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> connectHOC(selectorFactory, _extends(&#123;</span><br><span class="line">        initMapStateToProps: initMapStateToProps,</span><br><span class="line">        initMapDispatchToProps: initMapDispatchToProps,</span><br><span class="line">        initMergeProps: initMergeProps,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mapStateToProps 是个函数 initMapStateToProps 是 whenMapDispatchToPropsIsFunction 执行过后的结果。</p>
<p>whenMapStateToPropsIsFunction 调用了 wrapMapToPropsFunc(mapStateToProps, ‘mapStateToProps’)，需要分析一下 wrapMapToPropsFunc，它返回的是一个闭包函数，存储了传入的 mapToProps, methodName</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initProxySelector</span>(<span class="params">dispatch, _ref</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> displayName = _ref.displayName</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 顾名思义，就是个代理，stateOrDispatch与mapToProps之间的桥梁</span></span><br><span class="line">        <span class="comment">// 前提是mapToProps必须是个函数</span></span><br><span class="line">        <span class="keyword">var</span> proxy = <span class="function"><span class="keyword">function</span> <span class="title">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> proxy.dependsOnOwnProps</span><br><span class="line">                ? proxy.mapToProps(stateOrDispatch, ownProps)</span><br><span class="line">                : proxy.mapToProps(stateOrDispatch)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// allow detectFactoryAndVerify to get ownProps</span></span><br><span class="line">        proxy.dependsOnOwnProps = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        proxy.mapToProps = <span class="function"><span class="keyword">function</span> <span class="title">detectFactoryAndVerify</span>(<span class="params"></span><br><span class="line">            stateOrDispatch,</span><br><span class="line">            ownProps</span><br><span class="line">        </span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 原本的属性mapStateToProps</span></span><br><span class="line">            proxy.mapToProps = mapToProps</span><br><span class="line">            <span class="comment">// mapToProps.dependsOnOwnProps !== null &amp;&amp; mapToProps.dependsOnOwnProps !== undefined ? Boolean(mapToProps.dependsOnOwnProps) : mapToProps.length !== 1;</span></span><br><span class="line">            proxy.dependsOnOwnProps = getDependsOnOwnProps(mapToProps)</span><br><span class="line">            <span class="keyword">var</span> props = proxy(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">'function'</span>) &#123;</span><br><span class="line">                proxy.mapToProps = props</span><br><span class="line">                proxy.dependsOnOwnProps = getDependsOnOwnProps(props)</span><br><span class="line">                props = proxy(stateOrDispatch, ownProps)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            verifyPlainObject(props, displayName, methodName)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> props</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> proxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以 initMapStateToProps 执行过后其实就是这个 initProxySelector 闭包。</p>
<p>再来看看 mapDispatchToProps，如果是个函数，那就还是走上面那套。通常这是个对象，所以 initMapDispatchToProps 是执行 whenMapDispatchToPropsIsObject 过后的结果，定义在该对象的函数都将被当作 Redux action creator，如下所示</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">whenMapDispatchToPropsIsObject</span>(<span class="params">mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mapDispatchToProps &amp;&amp; <span class="keyword">typeof</span> mapDispatchToProps === <span class="string">'object'</span></span><br><span class="line">        ? wrapMapToPropsConstant(<span class="function"><span class="keyword">function</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> redux.bindActionCreators(mapDispatchToProps, dispatch)</span><br><span class="line">          &#125;)</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么 wrapMapToPropsConstant 返回的是如下函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initConstantSelector</span>(<span class="params">dispatch, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> constant = (<span class="function"><span class="keyword">function</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//即上文传入的mapStateToProps</span></span><br><span class="line">        <span class="keyword">return</span> redux.bindActionCreators(mapDispatchToProps, dispatch)</span><br><span class="line">    &#125;)(dispatch, options)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">constantSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> constant</span><br><span class="line">    &#125;</span><br><span class="line">    constantSelector.dependsOnOwnProps = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> constantSelector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>connectHOC 可以通过 createConnect 传入，默认情况是 connectAdvanced:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// selectorFactory 也可以通过 createConnect 传入，默认是 finalPropsSelectorFactory</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params">selectorFactory</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// _ref是传入的包含initMapStateToProps的对象</span></span><br><span class="line">    <span class="comment">// 创建一个新对象复制_ref的值，但不包括第二个参数数组里的value对应key的值</span></span><br><span class="line">    connectOptions = objectWithoutProperties(_ref, [</span><br><span class="line">        <span class="string">'getDisplayName'</span>,</span><br><span class="line">        <span class="string">'methodName'</span>,</span><br><span class="line">        <span class="string">'renderCountProp'</span>,</span><br><span class="line">        <span class="string">'shouldHandleStateChanges'</span>,</span><br><span class="line">        <span class="string">'storeKey'</span>,</span><br><span class="line">        <span class="string">'withRef'</span></span><br><span class="line">    ])</span><br><span class="line">    <span class="comment">// connect(mapStateToProps, mapDispatchToProps)执行过后返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">        invariant_1$<span class="number">2</span>(</span><br><span class="line">            <span class="keyword">typeof</span> WrappedComponent == <span class="string">'function'</span>,</span><br><span class="line">            <span class="string">'You must pass a component to the function returned by '</span> +</span><br><span class="line">                (methodName +</span><br><span class="line">                    <span class="string">'. Instead received '</span> +</span><br><span class="line">                    <span class="built_in">JSON</span>.stringify(WrappedComponent))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> wrappedComponentName =</span><br><span class="line">            WrappedComponent.displayName || WrappedComponent.name || <span class="string">'Component'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> displayName = getDisplayName(wrappedComponentName)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其中包含我们的initMapStateToProps</span></span><br><span class="line">        <span class="keyword">var</span> selectorFactoryOptions = _extends(&#123;&#125;, connectOptions, &#123;</span><br><span class="line">            ...<span class="comment">//省略了一些属性</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 匿名函数，内部生成一个组件，然后返回</span></span><br><span class="line">        <span class="keyword">var</span> Connect = (<span class="function"><span class="keyword">function</span>(<span class="params">_Component</span>) </span>&#123;</span><br><span class="line">            inherits(Connect, _Component)</span><br><span class="line">            <span class="comment">// 这个组件就是我们所说的容器组件了</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">Connect</span>(<span class="params">props, context</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> _this = possibleConstructorReturn(</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    _Component.call(<span class="keyword">this</span>, props, context)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将store存到了实例里</span></span><br><span class="line">                _this.store = props[storeKey] || context[storeKey]</span><br><span class="line">                _this.initSelector()</span><br><span class="line">                _this.initSubscription()</span><br><span class="line">                <span class="keyword">return</span> _this</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Connect.prototype.initSelector = <span class="function"><span class="keyword">function</span> <span class="title">initSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// selectorFactory 默认是 finalPropsSelectorFactory，下面会做分析</span></span><br><span class="line">                <span class="keyword">var</span> sourceSelector = selectorFactory(</span><br><span class="line">                    <span class="keyword">this</span>.store.dispatch,</span><br><span class="line">                    selectorFactoryOptions</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</span><br><span class="line">                <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;)(react.Component)</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">            此方法将传入的WrappedComponent业务组件的属性方法，但不包括</span><br><span class="line">            REACT_STATICS，KNOWN_STATICS常量中的属性方法复制到Connect组件</span><br><span class="line">        **/</span></span><br><span class="line">        <span class="keyword">return</span> hoistNonReactStatics(Connect, WrappedComponent)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Connect.prototype.initSelector 中调用的 selectorFactory 默认是 finalPropsSelectorFactory，如下，而传入的参数_ref2 中包含了我们上文传入的 initMapStateToProps，initMapDispatchToProps，initMergeProps，还记得吧，这三个参数都是函数，上面做过分析</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalPropsSelectorFactory</span>(<span class="params">dispatch, _ref2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> initMapStateToProps = _ref2.initMapStateToProps,</span><br><span class="line">        initMapDispatchToProps = _ref2.initMapDispatchToProps,</span><br><span class="line">        initMergeProps = _ref2.initMergeProps,</span><br><span class="line">        <span class="comment">// 重新生成一个对象，不包含这三个参数</span></span><br><span class="line">        options = objectWithoutProperties(_ref2, [</span><br><span class="line">            <span class="string">'initMapStateToProps'</span>,</span><br><span class="line">            <span class="string">'initMapDispatchToProps'</span>,</span><br><span class="line">            <span class="string">'initMergeProps'</span></span><br><span class="line">        ])</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">var</span> mapStateToProps = initMapStateToProps(dispatch, options)</span><br><span class="line">    <span class="comment">// 所有redux action creators</span></span><br><span class="line">    <span class="keyword">var</span> mapDispatchToProps = initMapDispatchToProps(dispatch, options)</span><br><span class="line">    <span class="keyword">var</span> mergeProps = initMergeProps(dispatch, options)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        verifySubselectors(</span><br><span class="line">            mapStateToProps,</span><br><span class="line">            mapDispatchToProps,</span><br><span class="line">            mergeProps,</span><br><span class="line">            options.displayName</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> selectorFactory = options.pure</span><br><span class="line">        ? pureFinalPropsSelectorFactory</span><br><span class="line">        : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> selectorFactory(</span><br><span class="line">        mapStateToProps,</span><br><span class="line">        mapDispatchToProps,</span><br><span class="line">        mergeProps,</span><br><span class="line">        dispatch,</span><br><span class="line">        options</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后来看看 impureFinalPropsSelectorFactory</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelectorFactory</span>(<span class="params"></span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch</span><br><span class="line"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelector</span>(<span class="params">state, ownProps</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mergeProps(</span><br><span class="line">            mapStateToProps(state, ownProps),</span><br><span class="line">            mapDispatchToProps(dispatch, ownProps),</span><br><span class="line">            ownProps</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到 impureFinalPropsSelector 返回的就是具体的 state 中的值，以及上文的 redux action creators 组成的 props<br>再回头看 Connect 中的 initSelector：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sourceSelector = selectorFactory(</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch,</span><br><span class="line">    selectorFactoryOptions</span><br><span class="line">)</span><br><span class="line"><span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</span><br><span class="line"><span class="comment">// 将传入的mapStateToProps、mapDispatchToProps与this.props合并，并放到this.selector.props中</span></span><br><span class="line"><span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br></pre></td></tr></table></figure>
<p>selectorFactory 就是 impureFinalPropsSelectorFactory 的返回值。<br>看一下 makeSelectorStateful：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSelectorStateful</span>(<span class="params">sourceSelector, store</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// wrap the selector in an object that tracks its results between runs.</span></span><br><span class="line">    <span class="keyword">var</span> selector = &#123;</span><br><span class="line">        run: <span class="function"><span class="keyword">function</span> <span class="title">runComponentSelector</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 更新注入其中的mapStateToProps、mapDispatchToProps中注入过去的值</span></span><br><span class="line">                <span class="keyword">var</span> nextProps = sourceSelector(store.getState(), props)</span><br><span class="line">                <span class="keyword">if</span> (nextProps !== selector.props || selector.error) &#123;</span><br><span class="line">                    <span class="comment">// 容器组件是否更新也是取决于此</span></span><br><span class="line">                    selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">                    <span class="comment">// 更新props，</span></span><br><span class="line">                    selector.props = nextProps</span><br><span class="line">                    selector.error = <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">                selector.error = error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> selector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过这一系列的处理，我们的 mapStateToProps, mapDispatchToProps 涉及的 state 和 dispatch redux action creators 都一起放到了一个 Connect 组件的 selector.props</p>
<p>Connect 的 render 方法里直接重新创建一个 element 将 selector.props 放入到我们传入的实际业务组件里：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Connect.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> selector = <span class="keyword">this</span>.selector</span><br><span class="line">    selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selector.error) &#123;</span><br><span class="line">        <span class="keyword">throw</span> selector.error</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> react.createElement(</span><br><span class="line">            WrappedComponent,</span><br><span class="line">            <span class="keyword">this</span>.addExtraProps(selector.props)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以经过上面这些流程，我们就可以在业务组件里直接使用 this.props.stateName, this.props.dispatchName 来使用我们的方法了。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>react-redux 首先通过 Provider 借用 getChildContext 让子组件取到 store，然后 connect 函数中在 connectHOC 之前，通过判断 mapStateToProps/mapDispatchToProps 的类型，分别创建闭包函数，然后在 connectHOC 中，创建一个 Connect 容器组件，在这个容器组件中将之前处理过的闭包函数赋值到 Connect 的 selector，并且将 selector 具体的属性注入到子组件的 props 里，同时 setState、shouldComponentWillUpdate 等操作或者判断都在操作这个 selector，以此来完成整个组件更新。</p>
<p>代码中运用了大量的函数式编程，要搞清楚还是要花点时间。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      Myths
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://myt0.com/2018/07/17/analysis-of-react-redux/" title="redux和react-redux原理分析">http://myt0.com/2018/07/17/analysis-of-react-redux/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="external nofollow" target="_blank">CC BY-NC-ND 4.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/javascript/" rel="tag"># javascript</a>
          
            <a href="/tags/react/" rel="tag"># react</a>
          
            <a href="/tags/react-redux/" rel="tag"># react-redux</a>
          
            <a href="/tags/redux/" rel="tag"># redux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/27/web性能优化/" rel="next" title="web性能优化">
                <i class="fa fa-chevron-left"></i> web性能优化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/01/summary-of-webpack/" rel="prev" title="webpack4 笔记">
                webpack4 笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="container"></div>
      <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
      <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
      <script>
          var gitment = new Gitment({
              id: '1531839600000',
              owner: 'coldhurt',
              repo: 'myt0.com',
              oauth: {
                  client_id: '6817e90a06fbbab23b57',
                  client_secret: 'cd611f36bd84e1ff6e0de7862f34c724f01a2402',
              },
          })
          gitment.render('container')
      </script>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/logo.jpg"
               alt="Myths" />
          <p class="site-author-name" itemprop="name">Myths</p>
           
              <p class="site-description motion-element" itemprop="description">Funny world, lonely world</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redux"><span class="nav-number">2.</span> <span class="nav-text">redux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createStore"><span class="nav-number">2.1.</span> <span class="nav-text">createStore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#combineReducers"><span class="nav-number">2.2.</span> <span class="nav-text">combineReducers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bindActionCreators"><span class="nav-number">2.3.</span> <span class="nav-text">bindActionCreators</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#applyMiddleware"><span class="nav-number">2.4.</span> <span class="nav-text">applyMiddleware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compose"><span class="nav-number">2.5.</span> <span class="nav-text">compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">2.6.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-redux"><span class="nav-number">3.</span> <span class="nav-text">react-redux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Provider"><span class="nav-number">3.1.</span> <span class="nav-text">Provider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createProvider"><span class="nav-number">3.2.</span> <span class="nav-text">createProvider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connect"><span class="nav-number">3.3.</span> <span class="nav-text">connect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-1"><span class="nav-number">3.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Myths</span>
</div>


<!--<div class="powered-by">
  Copyright © 2017 Myths
</div>-->

<!--<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>-->


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  
    <div id="container"></div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            id: '1531839600000',
            owner: 'coldhurt',
            repo: 'myt0.com',
            oauth: {
                client_id: '6817e90a06fbbab23b57',
                client_secret: 'cd611f36bd84e1ff6e0de7862f34c724f01a2402',
            },
        })
        gitment.render('container')
    </script>



  





  

  

  

  

  

  

</body>
</html>
